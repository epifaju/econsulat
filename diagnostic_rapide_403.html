<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Diagnostic Rapide Erreur 403</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        .info { border-color: #17a2b8; background: #d1ecf1; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 15px; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; background: #f8f9fa; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Diagnostic Rapide Erreur 403</h1>
        
        <div class="section info">
            <h3>ğŸ“Š Analyse des Logs</h3>
            <p><strong>âœ… Authentification JWT :</strong> Fonctionne correctement</p>
            <p><strong>âœ… Utilisateur :</strong> Epifanio GonÃ§alves (ROLE_USER)</p>
            <p><strong>âœ… Endpoints accessibles :</strong> /api/notifications/my</p>
            <p><strong>âŒ ProblÃ¨me :</strong> /api/demandes retourne 403</p>
        </div>

        <!-- Test Rapide -->
        <div class="section">
            <h3>ğŸ§ª Test Rapide des Endpoints</h3>
            <button onclick="testAllEndpoints()">ğŸ” Tester tous les endpoints</button>
            <button onclick="testDemandeSpecific()">ğŸ“ Test spÃ©cifique /api/demandes</button>
            <div id="testResult" class="result"></div>
        </div>

        <!-- Diagnostic SÃ©curitÃ© -->
        <div class="section">
            <h3>ğŸ” Diagnostic de SÃ©curitÃ©</h3>
            <button onclick="checkSecurityRules()">ğŸ” VÃ©rifier les rÃ¨gles de sÃ©curitÃ©</button>
            <button onclick="checkUserPermissions()">ğŸ‘¤ VÃ©rifier les permissions utilisateur</div>
            <div id="securityResult" class="result"></div>
        </div>

        <!-- Logs -->
        <div class="section">
            <h3>ğŸ“Š Logs de Test</h3>
            <button onclick="clearLogs()">ğŸ—‘ï¸ Effacer</button>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        let currentToken = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logsDiv.innerHTML += `[${timestamp}] <span class="${statusClass}">${type.toUpperCase()}</span> ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
        }

        // Connexion automatique avec les identifiants des logs
        async function autoLogin() {
            try {
                log('ğŸ” Connexion automatique...', 'info');
                
                const response = await fetch('http://127.0.0.1:8080/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: 'guinebissauanuncios@gmail.com', 
                        password: 'password123' 
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    log('âœ… Connexion rÃ©ussie', 'success');
                    log(`ğŸ“§ Email: ${data.email}`, 'info');
                    log(`ğŸ‘‘ RÃ´le: ${data.role}`, 'info');
                    return true;
                } else {
                    log(`âŒ Erreur de connexion: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Erreur: ${error.message}`, 'error');
                return false;
            }
        }

        async function testAllEndpoints() {
            if (!currentToken) {
                const connected = await autoLogin();
                if (!connected) {
                    showResult('testResult', 'error', 'âŒ Impossible de se connecter');
                    return;
                }
            }

            try {
                log('ğŸŒ Test de tous les endpoints...', 'info');
                
                const endpoints = [
                    { name: 'GET /api/notifications/my', url: '/api/notifications/my', method: 'GET' },
                    { name: 'GET /api/demandes/civilites', url: '/api/demandes/civilites', method: 'GET' },
                    { name: 'GET /api/demandes/pays', url: '/api/demandes/pays', method: 'GET' },
                    { name: 'GET /api/demandes/document-types', url: '/api/demandes/document-types', method: 'GET' },
                    { name: 'GET /api/demandes/my', url: '/api/demandes/my', method: 'GET' },
                    { name: 'POST /api/demandes', url: '/api/demandes', method: 'POST' }
                ];

                let results = `ğŸŒ Test des Endpoints\n\n`;

                for (const endpoint of endpoints) {
                    try {
                        let response;
                        if (endpoint.method === 'POST') {
                            const testData = {
                                civiliteId: 1, firstName: "Test", lastName: "User",
                                birthDate: "1990-01-01", birthPlace: "Test", birthCountryId: 1,
                                streetName: "Test", streetNumber: "123", postalCode: "12345", city: "Test",
                                countryId: 1, fatherFirstName: "Test", fatherLastName: "Father",
                                fatherBirthDate: "1960-01-01", fatherBirthPlace: "Test", fatherBirthCountryId: 1,
                                motherFirstName: "Test", motherLastName: "Mother", motherBirthDate: "1965-01-01",
                                motherBirthPlace: "Test", motherBirthCountryId: 1, documentTypeId: 1, documentFiles: []
                            };

                            response = await fetch(`http://127.0.0.1:8080${endpoint.url}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${currentToken}`
                                },
                                body: JSON.stringify(testData)
                            });
                        } else {
                            response = await fetch(`http://127.0.0.1:8080${endpoint.url}`, {
                                headers: { 'Authorization': `Bearer ${currentToken}` }
                            });
                        }

                        const status = response.status;
                        if (status === 200 || status === 201) {
                            results += `âœ… ${endpoint.name}: ${status}\n`;
                            log(`âœ… ${endpoint.name}: ${status}`, 'success');
                        } else if (status === 403) {
                            results += `âŒ ${endpoint.name}: ${status} (FORBIDDEN)\n`;
                            log(`âŒ ${endpoint.name}: ${status} (FORBIDDEN)`, 'error');
                        } else if (status === 401) {
                            results += `ğŸ”’ ${endpoint.name}: ${status} (UNAUTHORIZED)\n`;
                            log(`ğŸ”’ ${endpoint.name}: ${status} (UNAUTHORIZED)`, 'warning');
                        } else {
                            results += `âš ï¸ ${endpoint.name}: ${status}\n`;
                            log(`âš ï¸ ${endpoint.name}: ${status}`, 'warning');
                        }

                    } catch (error) {
                        results += `ğŸ’¥ ${endpoint.name}: Erreur - ${error.message}\n`;
                        log(`ğŸ’¥ ${endpoint.name}: Erreur - ${error.message}`, 'error');
                    }
                }

                showResult('testResult', 'info', results);
                log('ğŸŒ Test terminÃ©', 'info');

            } catch (error) {
                log(`âŒ Erreur: ${error.message}`, 'error');
                showResult('testResult', 'error', `âŒ Erreur: ${error.message}`);
            }
        }

        async function testDemandeSpecific() {
            if (!currentToken) {
                const connected = await autoLogin();
                if (!connected) {
                    showResult('testResult', 'error', 'âŒ Impossible de se connecter');
                    return;
                }
            }

            try {
                log('ğŸ“ Test spÃ©cifique /api/demandes...', 'info');
                
                const testDemande = {
                    civiliteId: 1, firstName: "Test", lastName: "User",
                    birthDate: "1990-01-01", birthPlace: "Test", birthCountryId: 1,
                    streetName: "Test", streetNumber: "123", postalCode: "12345", city: "Test",
                    countryId: 1, fatherFirstName: "Test", fatherLastName: "Father",
                    fatherBirthDate: "1960-01-01", fatherBirthPlace: "Test", fatherBirthCountryId: 1,
                    motherFirstName: "Test", motherLastName: "Mother", motherBirthDate: "1965-01-01",
                    motherBirthPlace: "Test", motherBirthCountryId: 1, documentTypeId: 1, documentFiles: []
                };

                log(`ğŸ“¤ DonnÃ©es: ${JSON.stringify(testDemande, null, 2)}`, 'info');

                const response = await fetch('http://127.0.0.1:8080/api/demandes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(testDemande)
                });

                let result = `ğŸ“ Test /api/demandes\n\n`;
                result += `ğŸ“¤ DonnÃ©es envoyÃ©es: ${JSON.stringify(testDemande, null, 2)}\n\n`;
                result += `ğŸ“¥ RÃ©ponse: ${response.status} ${response.statusText}\n`;
                result += `ğŸ”‘ Token: ${currentToken.substring(0, 50)}...\n`;

                if (response.ok) {
                    const data = await response.json();
                    result += `\nâœ… SuccÃ¨s! ID: ${data.id}`;
                    log('âœ… Demande crÃ©Ã©e avec succÃ¨s!', 'success');
                } else if (response.status === 403) {
                    result += `\nâŒ 403 Forbidden - ProblÃ¨me d'autorisation`;
                    log('âŒ 403 Forbidden', 'error');
                    
                    try {
                        const errorData = await response.text();
                        if (errorData) {
                            result += `\nğŸ“„ DÃ©tails: ${errorData}`;
                        }
                    } catch (parseError) {
                        result += `\nğŸ“„ RÃ©ponse vide`;
                    }
                } else {
                    result += `\nâš ï¸ Erreur ${response.status}: ${response.statusText}`;
                }

                showResult('testResult', 'info', result);

            } catch (error) {
                log(`âŒ Erreur: ${error.message}`, 'error');
                showResult('testResult', 'error', `âŒ Erreur: ${error.message}`);
            }
        }

        async function checkSecurityRules() {
            try {
                log('ğŸ” VÃ©rification des rÃ¨gles de sÃ©curitÃ©...', 'info');
                
                let result = `ğŸ” RÃ¨gles de SÃ©curitÃ©\n\n`;
                
                // Test des endpoints publics
                const publicEndpoints = [
                    '/api/demandes/civilites',
                    '/api/demandes/pays',
                    '/api/demandes/document-types'
                ];

                for (const endpoint of publicEndpoints) {
                    try {
                        const response = await fetch(`http://127.0.0.1:8080${endpoint}`);
                        if (response.ok) {
                            result += `âœ… ${endpoint}: Public (accessible sans token)\n`;
                        } else {
                            result += `âŒ ${endpoint}: ${response.status} ${response.statusText}\n`;
                        }
                    } catch (error) {
                        result += `ğŸ’¥ ${endpoint}: Erreur - ${error.message}\n`;
                    }
                }

                // Test des endpoints protÃ©gÃ©s
                if (currentToken) {
                    result += `\nğŸ”’ Endpoints protÃ©gÃ©s:\n`;
                    
                    const protectedEndpoints = [
                        '/api/demandes',
                        '/api/demandes/my'
                    ];

                    for (const endpoint of protectedEndpoints) {
                        try {
                            const response = await fetch(`http://127.0.0.1:8080${endpoint}`, {
                                headers: { 'Authorization': `Bearer ${currentToken}` }
                            });
                            
                            if (response.status === 200 || response.status === 201) {
                                result += `âœ… ${endpoint}: Accessible avec token\n`;
                            } else if (response.status === 403) {
                                result += `âŒ ${endpoint}: 403 Forbidden\n`;
                            } else {
                                result += `âš ï¸ ${endpoint}: ${response.status} ${response.statusText}\n`;
                            }
                        } catch (error) {
                            result += `ğŸ’¥ ${endpoint}: Erreur - ${error.message}\n`;
                        }
                    }
                }

                showResult('securityResult', 'info', result);
                log('ğŸ” VÃ©rification terminÃ©e', 'info');

            } catch (error) {
                log(`âŒ Erreur: ${error.message}`, 'error');
                showResult('securityResult', 'error', `âŒ Erreur: ${error.message}`);
            }
        }

        async function checkUserPermissions() {
            if (!currentToken) {
                showResult('securityResult', 'error', 'âŒ Aucun token disponible');
                return;
            }

            try {
                log('ğŸ‘¤ VÃ©rification des permissions utilisateur...', 'info');
                
                let result = `ğŸ‘¤ Permissions Utilisateur\n\n`;
                
                // Test /api/auth/me
                try {
                    const meResponse = await fetch('http://127.0.0.1:8080/api/auth/me', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    
                    if (meResponse.ok) {
                        const meData = await meResponse.json();
                        result += `âœ… /api/auth/me accessible\n`;
                        result += `â€¢ ID: ${meData.id}\n`;
                        result += `â€¢ Email: ${meData.email}\n`;
                        result += `â€¢ RÃ´le: ${meData.role}\n`;
                        result += `â€¢ Compte actif: ${meData.enabled}\n`;
                        result += `â€¢ Email vÃ©rifiÃ©: ${meData.emailVerified}\n`;
                        
                        if (meData.authorities) {
                            result += `â€¢ AutoritÃ©s: ${JSON.stringify(meData.authorities)}\n`;
                        }
                    } else {
                        result += `âŒ /api/auth/me: ${meResponse.status} ${meResponse.statusText}\n`;
                    }
                } catch (error) {
                    result += `ğŸ’¥ /api/auth/me: Erreur - ${error.message}\n`;
                }

                // Test des permissions sur les demandes
                result += `\nğŸ” Permissions sur les demandes:\n`;
                
                try {
                    const demandesResponse = await fetch('http://127.0.0.1:8080/api/demandes/my', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    
                    if (demandesResponse.ok) {
                        const demandes = await demandesResponse.json();
                        result += `âœ… /api/demandes/my: Accessible (${demandes.length} demandes)\n`;
                    } else if (demandesResponse.status === 403) {
                        result += `âŒ /api/demandes/my: 403 Forbidden\n`;
                    } else {
                        result += `âš ï¸ /api/demandes/my: ${demandesResponse.status} ${demandesResponse.statusText}\n`;
                    }
                } catch (error) {
                    result += `ğŸ’¥ /api/demandes/my: Erreur - ${error.message}\n`;
                }

                showResult('securityResult', 'info', result);
                log('ğŸ‘¤ VÃ©rification terminÃ©e', 'info');

            } catch (error) {
                log(`âŒ Erreur: ${error.message}`, 'error');
                showResult('securityResult', 'error', `âŒ Erreur: ${error.message}`);
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('ğŸ—‘ï¸ Logs effacÃ©s', 'warning');
        }

        // Initialisation
        log('ğŸš€ Diagnostic rapide dÃ©marrÃ©', 'info');
        log('ğŸ’¡ Utilisation des identifiants des logs serveur', 'info');
    </script>
</body>
</html>
