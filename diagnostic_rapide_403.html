<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagnostic Rapide Erreur 403</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        .info { border-color: #17a2b8; background: #d1ecf1; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 15px; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; background: #f8f9fa; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Rapide Erreur 403</h1>
        
        <div class="section info">
            <h3>üìä Analyse des Logs</h3>
            <p><strong>‚úÖ Authentification JWT :</strong> Fonctionne correctement</p>
            <p><strong>‚úÖ Utilisateur :</strong> Epifanio Gon√ßalves (ROLE_USER)</p>
            <p><strong>‚úÖ Endpoints accessibles :</strong> /api/notifications/my</p>
            <p><strong>‚ùå Probl√®me :</strong> /api/demandes retourne 403</p>
        </div>

        <!-- Test Rapide -->
        <div class="section">
            <h3>üß™ Test Rapide des Endpoints</h3>
            <button onclick="testAllEndpoints()">üîç Tester tous les endpoints</button>
            <button onclick="testDemandeSpecific()">üìù Test sp√©cifique /api/demandes</button>
            <div id="testResult" class="result"></div>
        </div>

        <!-- Diagnostic S√©curit√© -->
        <div class="section">
            <h3>üîê Diagnostic de S√©curit√©</h3>
            <button onclick="checkSecurityRules()">üîç V√©rifier les r√®gles de s√©curit√©</button>
            <button onclick="checkUserPermissions()">üë§ V√©rifier les permissions utilisateur</div>
            <div id="securityResult" class="result"></div>
        </div>

        <!-- Logs -->
        <div class="section">
            <h3>üìä Logs de Test</h3>
            <button onclick="clearLogs()">üóëÔ∏è Effacer</button>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        let currentToken = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logsDiv.innerHTML += `[${timestamp}] <span class="${statusClass}">${type.toUpperCase()}</span> ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
        }

        // Connexion automatique avec les identifiants des logs
        async function autoLogin() {
            try {
                log('üîê Connexion automatique...', 'info');
                
                const response = await fetch('http://127.0.0.1:8080/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: 'guinebissauanuncios@gmail.com', 
                        password: 'password123' 
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    log('‚úÖ Connexion r√©ussie', 'success');
                    log(`üìß Email: ${data.email}`, 'info');
                    log(`üëë R√¥le: ${data.role}`, 'info');
                    return true;
                } else {
                    log(`‚ùå Erreur de connexion: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                return false;
            }
        }

        async function testAllEndpoints() {
            if (!currentToken) {
                const connected = await autoLogin();
                if (!connected) {
                    showResult('testResult', 'error', '‚ùå Impossible de se connecter');
                    return;
                }
            }

            try {
                log('üåê Test de tous les endpoints...', 'info');
                
                const endpoints = [
                    { name: 'GET /api/notifications/my', url: '/api/notifications/my', method: 'GET' },
                    { name: 'GET /api/demandes/civilites', url: '/api/demandes/civilites', method: 'GET' },
                    { name: 'GET /api/demandes/pays', url: '/api/demandes/pays', method: 'GET' },
                    { name: 'GET /api/demandes/document-types', url: '/api/demandes/document-types', method: 'GET' },
                    { name: 'GET /api/demandes/my', url: '/api/demandes/my', method: 'GET' },
                    { name: 'POST /api/demandes', url: '/api/demandes', method: 'POST' }
                ];

                let results = `üåê Test des Endpoints\n\n`;

                for (const endpoint of endpoints) {
                    try {
                        let response;
                        if (endpoint.method === 'POST') {
                            const testData = {
                                civiliteId: 1, firstName: "Test", lastName: "User",
                                birthDate: "1990-01-01", birthPlace: "Test", birthCountryId: 1,
                                streetName: "Test", streetNumber: "123", postalCode: "12345", city: "Test",
                                countryId: 1, fatherFirstName: "Test", fatherLastName: "Father",
                                fatherBirthDate: "1960-01-01", fatherBirthPlace: "Test", fatherBirthCountryId: 1,
                                motherFirstName: "Test", motherLastName: "Mother", motherBirthDate: "1965-01-01",
                                motherBirthPlace: "Test", motherBirthCountryId: 1, documentTypeId: 1, documentFiles: []
                            };

                            response = await fetch(`http://127.0.0.1:8080${endpoint.url}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${currentToken}`
                                },
                                body: JSON.stringify(testData)
                            });
                        } else {
                            response = await fetch(`http://127.0.0.1:8080${endpoint.url}`, {
                                headers: { 'Authorization': `Bearer ${currentToken}` }
                            });
                        }

                        const status = response.status;
                        if (status === 200 || status === 201) {
                            results += `‚úÖ ${endpoint.name}: ${status}\n`;
                            log(`‚úÖ ${endpoint.name}: ${status}`, 'success');
                        } else if (status === 403) {
                            results += `‚ùå ${endpoint.name}: ${status} (FORBIDDEN)\n`;
                            log(`‚ùå ${endpoint.name}: ${status} (FORBIDDEN)`, 'error');
                        } else if (status === 401) {
                            results += `üîí ${endpoint.name}: ${status} (UNAUTHORIZED)\n`;
                            log(`üîí ${endpoint.name}: ${status} (UNAUTHORIZED)`, 'warning');
                        } else {
                            results += `‚ö†Ô∏è ${endpoint.name}: ${status}\n`;
                            log(`‚ö†Ô∏è ${endpoint.name}: ${status}`, 'warning');
                        }

                    } catch (error) {
                        results += `üí• ${endpoint.name}: Erreur - ${error.message}\n`;
                        log(`üí• ${endpoint.name}: Erreur - ${error.message}`, 'error');
                    }
                }

                showResult('testResult', 'info', results);
                log('üåê Test termin√©', 'info');

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                showResult('testResult', 'error', `‚ùå Erreur: ${error.message}`);
            }
        }

        async function testDemandeSpecific() {
            if (!currentToken) {
                const connected = await autoLogin();
                if (!connected) {
                    showResult('testResult', 'error', '‚ùå Impossible de se connecter');
                    return;
                }
            }

            try {
                log('üìù Test sp√©cifique /api/demandes...', 'info');
                
                const testDemande = {
                    civiliteId: 1, firstName: "Test", lastName: "User",
                    birthDate: "1990-01-01", birthPlace: "Test", birthCountryId: 1,
                    streetName: "Test", streetNumber: "123", postalCode: "12345", city: "Test",
                    countryId: 1, fatherFirstName: "Test", fatherLastName: "Father",
                    fatherBirthDate: "1960-01-01", fatherBirthPlace: "Test", fatherBirthCountryId: 1,
                    motherFirstName: "Test", motherLastName: "Mother", motherBirthDate: "1965-01-01",
                    motherBirthPlace: "Test", motherBirthCountryId: 1, documentTypeId: 1, documentFiles: []
                };

                log(`üì§ Donn√©es: ${JSON.stringify(testDemande, null, 2)}`, 'info');

                const response = await fetch('http://127.0.0.1:8080/api/demandes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(testDemande)
                });

                let result = `üìù Test /api/demandes\n\n`;
                result += `üì§ Donn√©es envoy√©es: ${JSON.stringify(testDemande, null, 2)}\n\n`;
                result += `üì• R√©ponse: ${response.status} ${response.statusText}\n`;
                result += `üîë Token: ${currentToken.substring(0, 50)}...\n`;

                if (response.ok) {
                    const data = await response.json();
                    result += `\n‚úÖ Succ√®s! ID: ${data.id}`;
                    log('‚úÖ Demande cr√©√©e avec succ√®s!', 'success');
                } else if (response.status === 403) {
                    result += `\n‚ùå 403 Forbidden - Probl√®me d'autorisation`;
                    log('‚ùå 403 Forbidden', 'error');
                    
                    try {
                        const errorData = await response.text();
                        if (errorData) {
                            result += `\nüìÑ D√©tails: ${errorData}`;
                        }
                    } catch (parseError) {
                        result += `\nüìÑ R√©ponse vide`;
                    }
                } else {
                    result += `\n‚ö†Ô∏è Erreur ${response.status}: ${response.statusText}`;
                }

                showResult('testResult', 'info', result);

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                showResult('testResult', 'error', `‚ùå Erreur: ${error.message}`);
            }
        }

        async function checkSecurityRules() {
            try {
                log('üîê V√©rification des r√®gles de s√©curit√©...', 'info');
                
                let result = `üîê R√®gles de S√©curit√©\n\n`;
                
                // Test des endpoints publics
                const publicEndpoints = [
                    '/api/demandes/civilites',
                    '/api/demandes/pays',
                    '/api/demandes/document-types'
                ];

                for (const endpoint of publicEndpoints) {
                    try {
                        const response = await fetch(`http://127.0.0.1:8080${endpoint}`);
                        if (response.ok) {
                            result += `‚úÖ ${endpoint}: Public (accessible sans token)\n`;
                        } else {
                            result += `‚ùå ${endpoint}: ${response.status} ${response.statusText}\n`;
                        }
                    } catch (error) {
                        result += `üí• ${endpoint}: Erreur - ${error.message}\n`;
                    }
                }

                // Test des endpoints prot√©g√©s
                if (currentToken) {
                    result += `\nüîí Endpoints prot√©g√©s:\n`;
                    
                    const protectedEndpoints = [
                        '/api/demandes',
                        '/api/demandes/my'
                    ];

                    for (const endpoint of protectedEndpoints) {
                        try {
                            const response = await fetch(`http://127.0.0.1:8080${endpoint}`, {
                                headers: { 'Authorization': `Bearer ${currentToken}` }
                            });
                            
                            if (response.status === 200 || response.status === 201) {
                                result += `‚úÖ ${endpoint}: Accessible avec token\n`;
                            } else if (response.status === 403) {
                                result += `‚ùå ${endpoint}: 403 Forbidden\n`;
                            } else {
                                result += `‚ö†Ô∏è ${endpoint}: ${response.status} ${response.statusText}\n`;
                            }
                        } catch (error) {
                            result += `üí• ${endpoint}: Erreur - ${error.message}\n`;
                        }
                    }
                }

                showResult('securityResult', 'info', result);
                log('üîê V√©rification termin√©e', 'info');

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                showResult('securityResult', 'error', `‚ùå Erreur: ${error.message}`);
            }
        }

        async function checkUserPermissions() {
            if (!currentToken) {
                showResult('securityResult', 'error', '‚ùå Aucun token disponible');
                return;
            }

            try {
                log('üë§ V√©rification des permissions utilisateur...', 'info');
                
                let result = `üë§ Permissions Utilisateur\n\n`;
                
                // Test /api/auth/me
                try {
                    const meResponse = await fetch('http://127.0.0.1:8080/api/auth/me', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    
                    if (meResponse.ok) {
                        const meData = await meResponse.json();
                        result += `‚úÖ /api/auth/me accessible\n`;
                        result += `‚Ä¢ ID: ${meData.id}\n`;
                        result += `‚Ä¢ Email: ${meData.email}\n`;
                        result += `‚Ä¢ R√¥le: ${meData.role}\n`;
                        result += `‚Ä¢ Compte actif: ${meData.enabled}\n`;
                        result += `‚Ä¢ Email v√©rifi√©: ${meData.emailVerified}\n`;
                        
                        if (meData.authorities) {
                            result += `‚Ä¢ Autorit√©s: ${JSON.stringify(meData.authorities)}\n`;
                        }
                    } else {
                        result += `‚ùå /api/auth/me: ${meResponse.status} ${meResponse.statusText}\n`;
                    }
                } catch (error) {
                    result += `üí• /api/auth/me: Erreur - ${error.message}\n`;
                }

                // Test des permissions sur les demandes
                result += `\nüîç Permissions sur les demandes:\n`;
                
                try {
                    const demandesResponse = await fetch('http://127.0.0.1:8080/api/demandes/my', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    
                    if (demandesResponse.ok) {
                        const demandes = await demandesResponse.json();
                        result += `‚úÖ /api/demandes/my: Accessible (${demandes.length} demandes)\n`;
                    } else if (demandesResponse.status === 403) {
                        result += `‚ùå /api/demandes/my: 403 Forbidden\n`;
                    } else {
                        result += `‚ö†Ô∏è /api/demandes/my: ${demandesResponse.status} ${demandesResponse.statusText}\n`;
                    }
                } catch (error) {
                    result += `üí• /api/demandes/my: Erreur - ${error.message}\n`;
                }

                showResult('securityResult', 'info', result);
                log('üë§ V√©rification termin√©e', 'info');

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                showResult('securityResult', 'error', `‚ùå Erreur: ${error.message}`);
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('üóëÔ∏è Logs effac√©s', 'warning');
        }

        // Initialisation
        log('üöÄ Diagnostic rapide d√©marr√©', 'info');
        log('üí° Utilisation des identifiants des logs serveur', 'info');
    </script>
</body>
</html>
