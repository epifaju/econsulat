<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontend Fix</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { 
            background-color: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { background-color: #0056b3; }
        .log { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-family: monospace; 
            white-space: pre-wrap; 
            max-height: 300px; 
            overflow-y: auto; 
        }
        input[type="text"] { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
    </style>
</head>
<body>
    <h1>üîß Test Frontend Fix - G√©n√©ration Document</h1>
    
    <div class="test-section info">
        <h3>üìã Probl√®me identifi√© et corrig√©</h3>
        <p><strong>Probl√®me :</strong> Conflit de noms de variables dans le frontend</p>
        <p><strong>Cause :</strong> La variable <code>document</code> √©tait utilis√©e √† la fois pour l'objet DOM et la r√©ponse API</p>
        <p><strong>Solution :</strong> Renomm√© la variable en <code>generatedDocument</code></p>
    </div>

    <div class="test-section">
        <h3>üîë Configuration</h3>
        <label>Token JWT:</label>
        <input type="text" id="token" placeholder="eyJhbGciOiJIUzI1NiJ9...">
        <br>
        <label>ID de la demande:</label>
        <input type="text" id="demandeId" placeholder="1" value="1">
        <br>
        <label>ID du type de document:</label>
        <input type="text" id="documentTypeId" placeholder="1" value="1">
    </div>

    <div class="test-section">
        <h3>üß™ Test de g√©n√©ration</h3>
        <button onclick="testGeneration()">üìÑ Tester la g√©n√©ration</button>
        <button onclick="clearLog()">üóëÔ∏è Effacer les logs</button>
    </div>

    <div class="test-section">
        <h3>üìù Logs</h3>
        <div id="log" class="log"></div>
    </div>

    <div class="test-section info">
        <h3>‚úÖ Instructions pour tester</h3>
        <ol>
            <li>Assurez-vous que le backend est d√©marr√© (port 8080)</li>
            <li>Assurez-vous que le frontend est d√©marr√© (port 5173)</li>
            <li>Connectez-vous √† l'interface admin</li>
            <li>R√©cup√©rez votre token JWT depuis les outils de d√©veloppement</li>
            <li>Collez le token dans le champ ci-dessus</li>
            <li>Cliquez sur "Tester la g√©n√©ration"</li>
        </ol>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${statusClass} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function testGeneration() {
            log('=== Test de g√©n√©ration de document ===');
            
            const token = document.getElementById('token').value;
            const demandeId = document.getElementById('demandeId').value;
            const documentTypeId = document.getElementById('documentTypeId').value;
            
            if (!token) {
                log('‚ùå Token requis pour ce test', 'error');
                return;
            }
            
            if (!demandeId || !documentTypeId) {
                log('‚ùå ID de demande et type de document requis', 'error');
                return;
            }
            
            try {
                log(`G√©n√©ration pour demande ${demandeId}, type ${documentTypeId}...`);
                
                const response = await fetch(
                    `http://localhost:8080/api/admin/documents/generate?demandeId=${demandeId}&documentTypeId=${documentTypeId}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                log(`Status: ${response.status}`);
                
                if (response.ok) {
                    const generatedDocument = await response.json();
                    log('‚úÖ Document g√©n√©r√© avec succ√®s', 'success');
                    log(`Document ID: ${generatedDocument.id}`);
                    log(`Nom du fichier: ${generatedDocument.fileName}`);
                    log(`Chemin: ${generatedDocument.filePath}`);
                    
                    // Test du t√©l√©chargement
                    log('Test du t√©l√©chargement...');
                    const downloadResponse = await fetch(
                        `http://localhost:8080/api/admin/documents/download/${generatedDocument.id}`,
                        {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }
                    );
                    
                    if (downloadResponse.ok) {
                        const blob = await downloadResponse.blob();
                        log(`‚úÖ T√©l√©chargement OK - Taille: ${blob.size} bytes`, 'success');
                        
                        // Cr√©er le lien de t√©l√©chargement
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = generatedDocument.fileName;
                        a.textContent = 'üì• T√©l√©charger le document g√©n√©r√©';
                        a.style.display = 'block';
                        a.style.margin = '10px 0';
                        a.style.padding = '10px';
                        a.style.backgroundColor = '#28a745';
                        a.style.color = 'white';
                        a.style.textDecoration = 'none';
                        a.style.borderRadius = '5px';
                        document.body.appendChild(a);
                        
                        log('üéâ Test r√©ussi ! Le probl√®me de conflit de variables est r√©solu.', 'success');
                    } else {
                        log(`‚ùå Erreur t√©l√©chargement: ${downloadResponse.status}`, 'error');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    log(`‚ùå Erreur g√©n√©ration: ${response.status}`, 'error');
                    if (errorData.message) {
                        log(`Message: ${errorData.message}`, 'error');
                    }
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                log(`Type d'erreur: ${error.name}`, 'error');
            }
        }

        // Initialisation
        window.onload = function() {
            log('üîß Test Frontend Fix initialis√©');
            log('‚ÑπÔ∏è Ce test v√©rifie que le conflit de variables est r√©solu');
        };
    </script>
</body>
</html> 