<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Diagnostic Erreur 403 - CrÃ©ation Demande</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 6px; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        .info { border-color: #17a2b8; background: #d1ecf1; }
        .form-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 15px; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; max-height: 400px; overflow-y: auto; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        .status.warning { background: #ffc107; color: black; }
        .step { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; }
        .debug-info { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Diagnostic Erreur 403 - CrÃ©ation Demande</h1>
        
        <div class="section info">
            <h3>ğŸ¯ ProblÃ¨me IdentifiÃ©</h3>
            <p><strong>Erreur :</strong> 403 Forbidden lors de la crÃ©ation d'une demande</p>
            <p><strong>SymptÃ´mes :</strong> L'utilisateur connectÃ© reÃ§oit une erreur 403 lors de la soumission du formulaire</p>
            <p><strong>Cause probable :</strong> ProblÃ¨me d'authentification JWT ou de configuration de sÃ©curitÃ©</p>
        </div>

        <!-- Section Connexion -->
        <div class="section">
            <h3>ğŸ”‘ Ã‰tape 1: Connexion et Diagnostic du Token</h3>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="votre@email.com" value="citizen@econsulat.com">
            </div>
            <div class="form-group">
                <label for="password">Mot de passe:</label>
                <input type="password" id="password" placeholder="Mot de passe" value="citizen123">
            </div>
            <button onclick="login()">ğŸ” Se connecter</button>
            <button onclick="diagnoseToken()">ğŸ” Diagnostiquer le token</button>
            <div id="loginResult" class="result"></div>
        </div>

        <!-- Section Test Endpoints -->
        <div class="section">
            <h3>ğŸŒ Ã‰tape 2: Test des Endpoints de Demandes</h3>
            <button onclick="testEndpoints()">ğŸ§ª Tester tous les endpoints</button>
            <button onclick="testCreateDemande()">ğŸ“ Tester la crÃ©ation de demande</button>
            <div id="endpointsTest" class="result"></div>
        </div>

        <!-- Section Diagnostic SÃ©curitÃ© -->
        <div class="section">
            <h3>ğŸ” Ã‰tape 3: Diagnostic de la Configuration de SÃ©curitÃ©</h3>
            <button onclick="checkSecurityConfig()">ğŸ” VÃ©rifier la configuration de sÃ©curitÃ©</button>
            <button onclick="checkUserAuthorities()">ğŸ‘‘ VÃ©rifier les autoritÃ©s utilisateur</button>
            <div id="securityDiagnostic" class="result"></div>
        </div>

        <!-- Section Test Base de DonnÃ©es -->
        <div class="section">
            <h3>ğŸ—„ï¸ Ã‰tape 4: VÃ©rification de la Base de DonnÃ©es</h3>
            <button onclick="checkDatabaseStructure()">ğŸ—ï¸ VÃ©rifier la structure de la base</button>
            <button onclick="checkUserInDatabase()">ğŸ‘¤ VÃ©rifier l'utilisateur en base</button>
            <div id="databaseDiagnostic" class="result"></div>
        </div>

        <!-- Section RÃ©solution -->
        <div class="section">
            <h3>ğŸ› ï¸ Ã‰tape 5: Solutions et RÃ©solution</h3>
            <button onclick="applyFixes()">ğŸ”§ Appliquer les corrections</button>
            <button onclick="restartBackend()">ğŸ”„ RedÃ©marrer le backend</button>
            <div id="resolutionResult" class="result"></div>
        </div>

        <!-- Section Logs -->
        <div class="section">
            <h3>ğŸ“Š Logs de Diagnostic</h3>
            <button onclick="clearLogs()">ğŸ—‘ï¸ Effacer les logs</button>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUser = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logsDiv.innerHTML += `[${timestamp}] <span class="status ${statusClass}">${type.toUpperCase()}</span> ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showResult('loginResult', 'error', 'âŒ Veuillez remplir tous les champs');
                return;
            }

            try {
                log('ğŸ” Tentative de connexion...', 'info');
                
                const response = await fetch('http://127.0.0.1:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    currentUser = { email: data.email, role: data.role };
                    
                    log('âœ… Connexion rÃ©ussie', 'success');
                    log(`ğŸ“§ Email: ${data.email}`, 'info');
                    log(`ğŸ‘‘ RÃ´le: ${data.role}`, 'info');
                    log(`ğŸ”‘ Token: ${data.token.substring(0, 50)}...`, 'info');
                    
                    showResult('loginResult', 'success', `âœ… Connexion rÃ©ussie!\nğŸ“§ Email: ${data.email}\nğŸ‘‘ RÃ´le: ${data.role}\nğŸ”‘ Token: ${data.token.substring(0, 50)}...`);
                } else {
                    const errorData = await response.text();
                    log(`âŒ Erreur de connexion: ${response.status} ${response.statusText}`, 'error');
                    log(`ğŸ“„ RÃ©ponse: ${errorData}`, 'error');
                    showResult('loginResult', 'error', `âŒ Erreur de connexion: ${response.status} ${response.statusText}\nğŸ“„ RÃ©ponse: ${errorData}`);
                }
            } catch (error) {
                log(`âŒ Erreur de connexion: ${error.message}`, 'error');
                showResult('loginResult', 'error', `âŒ Erreur de connexion: ${error.message}`);
            }
        }

        async function diagnoseToken() {
            if (!currentToken) {
                showResult('loginResult', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ” Diagnostic du token...', 'info');
                
                // Test 1: VÃ©rifier la validitÃ© du token
                const meResponse = await fetch('http://127.0.0.1:8080/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                let diagnostic = `ğŸ” Diagnostic du Token JWT\n\n`;
                diagnostic += `ğŸ”‘ Token: ${currentToken.substring(0, 50)}...\n`;
                diagnostic += `ğŸ“§ Email: ${currentUser.email}\n`;
                diagnostic += `ğŸ‘‘ RÃ´le: ${currentUser.role}\n\n`;

                if (meResponse.ok) {
                    const meData = await meResponse.json();
                    diagnostic += `âœ… Test /api/auth/me: OK\n`;
                    diagnostic += `ğŸ“„ RÃ©ponse: ${JSON.stringify(meData, null, 2)}\n`;
                    log('âœ… Token valide - /api/auth/me accessible', 'success');
                } else {
                    diagnostic += `âŒ Test /api/auth/me: ${meResponse.status} ${meResponse.statusText}\n`;
                    log(`âŒ Token invalide - /api/auth/me retourne ${meResponse.status}`, 'error');
                }

                // Test 2: VÃ©rifier l'accÃ¨s aux donnÃ©es de rÃ©fÃ©rence
                diagnostic += `\nğŸ” Test des donnÃ©es de rÃ©fÃ©rence:\n`;
                
                const [civilitesRes, paysRes, typesRes] = await Promise.all([
                    fetch('http://127.0.0.1:8080/api/demandes/civilites', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch('http://127.0.0.1:8080/api/demandes/pays', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch('http://127.0.0.1:8080/api/demandes/document-types', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    })
                ]);

                diagnostic += `â€¢ CivilitÃ©s: ${civilitesRes.status} ${civilitesRes.statusText}\n`;
                diagnostic += `â€¢ Pays: ${paysRes.status} ${paysRes.statusText}\n`;
                diagnostic += `â€¢ Types de documents: ${typesRes.status} ${typesRes.statusText}\n`;

                if (civilitesRes.ok && paysRes.ok && typesRes.ok) {
                    diagnostic += `\nâœ… Toutes les donnÃ©es de rÃ©fÃ©rence sont accessibles`;
                    log('âœ… DonnÃ©es de rÃ©fÃ©rence accessibles', 'success');
                } else {
                    diagnostic += `\nâŒ Certaines donnÃ©es de rÃ©fÃ©rence ne sont pas accessibles`;
                    log('âŒ ProblÃ¨me d\'accÃ¨s aux donnÃ©es de rÃ©fÃ©rence', 'error');
                }

                showResult('loginResult', 'info', diagnostic);

            } catch (error) {
                log(`âŒ Erreur lors du diagnostic: ${error.message}`, 'error');
                showResult('loginResult', 'error', `âŒ Erreur lors du diagnostic: ${error.message}`);
            }
        }

        async function testEndpoints() {
            if (!currentToken) {
                showResult('endpointsTest', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸŒ Test de tous les endpoints...', 'info');
                
                const endpoints = [
                    { name: 'GET /api/demandes', url: '/api/demandes', method: 'GET' },
                    { name: 'GET /api/demandes/my', url: '/api/demandes/my', method: 'GET' },
                    { name: 'GET /api/demandes/document-types', url: '/api/demandes/document-types', method: 'GET' },
                    { name: 'GET /api/demandes/civilites', url: '/api/demandes/civilites', method: 'GET' },
                    { name: 'GET /api/demandes/pays', url: '/api/demandes/pays', method: 'GET' },
                    { name: 'POST /api/demandes', url: '/api/demandes', method: 'POST' }
                ];

                let results = `ğŸŒ Test de tous les endpoints:\n\n`;

                for (const endpoint of endpoints) {
                    try {
                        let response;
                        if (endpoint.method === 'POST') {
                            // Pour POST, on envoie des donnÃ©es de test minimales
                            const testData = {
                                civiliteId: 1,
                                firstName: "Test",
                                lastName: "User",
                                birthDate: "1990-01-01",
                                birthPlace: "Test",
                                birthCountryId: 1,
                                streetName: "Test Street",
                                streetNumber: "123",
                                postalCode: "12345",
                                city: "Test City",
                                countryId: 1,
                                fatherFirstName: "Test",
                                fatherLastName: "Father",
                                fatherBirthDate: "1960-01-01",
                                fatherBirthPlace: "Test",
                                fatherBirthCountryId: 1,
                                motherFirstName: "Test",
                                motherLastName: "Mother",
                                motherBirthDate: "1965-01-01",
                                motherBirthPlace: "Test",
                                motherBirthCountryId: 1,
                                documentTypeId: 1,
                                documentFiles: []
                            };

                            response = await fetch(`http://127.0.0.1:8080${endpoint.url}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${currentToken}`
                                },
                                body: JSON.stringify(testData)
                            });
                        } else {
                            response = await fetch(`http://127.0.0.1:8080${endpoint.url}`, {
                                headers: {
                                    'Authorization': `Bearer ${currentToken}`
                                }
                            });
                        }

                        const status = response.status;
                        const statusText = response.statusText;
                        
                        if (status === 200 || status === 201) {
                            results += `âœ… ${endpoint.name}: ${status} ${statusText}\n`;
                            log(`âœ… ${endpoint.name}: ${status} ${statusText}`, 'success');
                        } else if (status === 403) {
                            results += `âŒ ${endpoint.name}: ${status} ${statusText} (FORBIDDEN)\n`;
                            log(`âŒ ${endpoint.name}: ${status} ${statusText} (FORBIDDEN)`, 'error');
                        } else if (status === 401) {
                            results += `ğŸ”’ ${endpoint.name}: ${status} ${statusText} (UNAUTHORIZED)\n`;
                            log(`ğŸ”’ ${endpoint.name}: ${status} ${statusText} (UNAUTHORIZED)`, 'warning');
                        } else {
                            results += `âš ï¸ ${endpoint.name}: ${status} ${statusText}\n`;
                            log(`âš ï¸ ${endpoint.name}: ${status} ${statusText}`, 'warning');
                        }

                    } catch (error) {
                        results += `ğŸ’¥ ${endpoint.name}: Erreur - ${error.message}\n`;
                        log(`ğŸ’¥ ${endpoint.name}: Erreur - ${error.message}`, 'error');
                    }
                }

                showResult('endpointsTest', 'info', results);
                log('ğŸŒ Test des endpoints terminÃ©', 'info');

            } catch (error) {
                log(`âŒ Erreur lors du test des endpoints: ${error.message}`, 'error');
                showResult('endpointsTest', 'error', `âŒ Erreur lors du test des endpoints: ${error.message}`);
            }
        }

        async function testCreateDemande() {
            if (!currentToken) {
                showResult('endpointsTest', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ“ Test de crÃ©ation de demande...', 'info');
                
                const testDemande = {
                    civiliteId: 1,
                    firstName: "Jean",
                    lastName: "Dupont",
                    birthDate: "1990-01-01",
                    birthPlace: "Paris",
                    birthCountryId: 1,
                    streetName: "Rue de la Paix",
                    streetNumber: "123",
                    boxNumber: "",
                    postalCode: "75001",
                    city: "Paris",
                    countryId: 1,
                    fatherFirstName: "Pierre",
                    fatherLastName: "Dupont",
                    fatherBirthDate: "1950-01-01",
                    fatherBirthPlace: "Lyon",
                    fatherBirthCountryId: 1,
                    motherFirstName: "Marie",
                    motherLastName: "Martin",
                    motherBirthDate: "1955-01-01",
                    motherBirthPlace: "Marseille",
                    motherBirthCountryId: 1,
                    documentTypeId: 1,
                    documentFiles: []
                };

                log(`ğŸ“¤ DonnÃ©es de test: ${JSON.stringify(testDemande, null, 2)}`, 'info');

                const response = await fetch('http://127.0.0.1:8080/api/demandes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(testDemande)
                });

                let result = `ğŸ“ Test de crÃ©ation de demande:\n\n`;
                result += `ğŸ“¤ DonnÃ©es envoyÃ©es: ${JSON.stringify(testDemande, null, 2)}\n\n`;
                result += `ğŸ“¥ RÃ©ponse reÃ§ue:\n`;
                result += `â€¢ Statut: ${response.status} ${response.statusText}\n`;
                result += `â€¢ Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}\n`;

                if (response.ok) {
                    const data = await response.json();
                    result += `\nâœ… Demande crÃ©Ã©e avec succÃ¨s!\n`;
                    result += `â€¢ ID: ${data.id}\n`;
                    result += `â€¢ Statut: ${data.status}\n`;
                    log('âœ… Demande crÃ©Ã©e avec succÃ¨s!', 'success');
                } else if (response.status === 403) {
                    result += `\nâŒ AccÃ¨s refusÃ© (403 Forbidden)\n`;
                    
                    // Essayer de rÃ©cupÃ©rer plus d'informations sur l'erreur
                    try {
                        const errorData = await response.text();
                        if (errorData) {
                            result += `â€¢ DÃ©tails de l'erreur: ${errorData}\n`;
                        } else {
                            result += `â€¢ RÃ©ponse vide (impossible de parser)\n`;
                        }
                    } catch (parseError) {
                        result += `â€¢ RÃ©ponse vide (impossible de parser)\n`;
                    }
                    
                    log('âŒ AccÃ¨s refusÃ© (403 Forbidden)', 'error');
                } else {
                    result += `\nâš ï¸ Autre erreur: ${response.status} ${response.statusText}\n`;
                    try {
                        const errorData = await response.text();
                        if (errorData) {
                            result += `â€¢ DÃ©tails: ${errorData}\n`;
                        }
                    } catch (parseError) {
                        result += `â€¢ Impossible de rÃ©cupÃ©rer les dÃ©tails\n`;
                    }
                    log(`âš ï¸ Erreur ${response.status}: ${response.statusText}`, 'warning');
                }

                showResult('endpointsTest', 'info', result);

            } catch (error) {
                log(`âŒ Erreur lors du test: ${error.message}`, 'error');
                showResult('endpointsTest', 'error', `âŒ Erreur lors du test: ${error.message}`);
            }
        }

        async function checkSecurityConfig() {
            if (!currentToken) {
                showResult('securityDiagnostic', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ” VÃ©rification de la configuration de sÃ©curitÃ©...', 'info');
                
                let diagnostic = `ğŸ” Diagnostic de la Configuration de SÃ©curitÃ©\n\n`;
                
                // Test 1: VÃ©rifier l'accÃ¨s aux endpoints publics
                diagnostic += `ğŸ” Test 1: Endpoints publics\n`;
                
                const publicEndpoints = [
                    '/api/demandes/document-types',
                    '/api/demandes/civilites',
                    '/api/demandes/pays'
                ];

                for (const endpoint of publicEndpoints) {
                    try {
                        const response = await fetch(`http://127.0.0.1:8080${endpoint}`);
                        if (response.ok) {
                            diagnostic += `âœ… ${endpoint}: Accessible sans authentification\n`;
                        } else {
                            diagnostic += `âŒ ${endpoint}: ${response.status} ${response.statusText}\n`;
                        }
                    } catch (error) {
                        diagnostic += `ğŸ’¥ ${endpoint}: Erreur - ${error.message}\n`;
                    }
                }

                // Test 2: VÃ©rifier l'accÃ¨s aux endpoints protÃ©gÃ©s
                diagnostic += `\nğŸ” Test 2: Endpoints protÃ©gÃ©s\n`;
                
                const protectedEndpoints = [
                    '/api/demandes',
                    '/api/demandes/my'
                ];

                for (const endpoint of protectedEndpoints) {
                    try {
                        const response = await fetch(`http://127.0.0.1:8080${endpoint}`, {
                            headers: {
                                'Authorization': `Bearer ${currentToken}`
                            }
                        });
                        
                        if (response.status === 200 || response.status === 201) {
                            diagnostic += `âœ… ${endpoint}: Accessible avec authentification\n`;
                        } else if (response.status === 403) {
                            diagnostic += `âŒ ${endpoint}: 403 Forbidden (problÃ¨me d'autorisation)\n`;
                        } else if (response.status === 401) {
                            diagnostic += `ğŸ”’ ${endpoint}: 401 Unauthorized (problÃ¨me d'authentification)\n`;
                        } else {
                            diagnostic += `âš ï¸ ${endpoint}: ${response.status} ${response.statusText}\n`;
                        }
                    } catch (error) {
                        diagnostic += `ğŸ’¥ ${endpoint}: Erreur - ${error.message}\n`;
                    }
                }

                // Test 3: VÃ©rifier les autoritÃ©s de l'utilisateur
                diagnostic += `\nğŸ” Test 3: AutoritÃ©s utilisateur\n`;
                diagnostic += `â€¢ Email: ${currentUser.email}\n`;
                diagnostic += `â€¢ RÃ´le: ${currentUser.role}\n`;
                
                // Tester l'endpoint /api/auth/me pour vÃ©rifier les autoritÃ©s
                try {
                    const meResponse = await fetch('http://127.0.0.1:8080/api/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        }
                    });
                    
                    if (meResponse.ok) {
                        const meData = await meResponse.json();
                        diagnostic += `â€¢ AutoritÃ©s: ${JSON.stringify(meData.authorities || [], null, 2)}\n`;
                        diagnostic += `â€¢ Compte actif: ${meData.enabled || 'N/A'}\n`;
                        diagnostic += `â€¢ Compte non expirÃ©: ${meData.accountNonExpired || 'N/A'}\n`;
                        diagnostic += `â€¢ Compte non verrouillÃ©: ${meData.accountNonLocked || 'N/A'}\n`;
                    } else {
                        diagnostic += `â€¢ Impossible de rÃ©cupÃ©rer les dÃ©tails utilisateur\n`;
                    }
                } catch (error) {
                    diagnostic += `â€¢ Erreur lors de la rÃ©cupÃ©ration des dÃ©tails: ${error.message}\n`;
                }

                showResult('securityDiagnostic', 'info', diagnostic);
                log('ğŸ” Diagnostic de sÃ©curitÃ© terminÃ©', 'info');

            } catch (error) {
                log(`âŒ Erreur lors du diagnostic de sÃ©curitÃ©: ${error.message}`, 'error');
                showResult('securityDiagnostic', 'error', `âŒ Erreur lors du diagnostic de sÃ©curitÃ©: ${error.message}`);
            }
        }

        async function checkUserAuthorities() {
            if (!currentToken) {
                showResult('securityDiagnostic', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ‘‘ VÃ©rification des autoritÃ©s utilisateur...', 'info');
                
                let result = `ğŸ‘‘ AutoritÃ©s de l'Utilisateur\n\n`;
                result += `ğŸ“§ Email: ${currentUser.email}\n`;
                result += `ğŸ‘‘ RÃ´le: ${currentUser.role}\n\n`;

                // Test 1: VÃ©rifier l'accÃ¨s aux endpoints admin
                result += `ğŸ” Test 1: AccÃ¨s aux endpoints admin\n`;
                
                const adminEndpoints = [
                    '/api/admin/demandes',
                    '/api/admin/users'
                ];

                for (const endpoint of adminEndpoints) {
                    try {
                        const response = await fetch(`http://127.0.0.1:8080${endpoint}`, {
                            headers: {
                                'Authorization': `Bearer ${currentToken}`
                            }
                        });
                        
                        if (response.status === 200) {
                            result += `âœ… ${endpoint}: AccÃ¨s autorisÃ© (rÃ´le admin)\n`;
                        } else if (response.status === 403) {
                            result += `âŒ ${endpoint}: AccÃ¨s refusÃ© (rÃ´le insuffisant)\n`;
                        } else {
                            result += `âš ï¸ ${endpoint}: ${response.status} ${response.statusText}\n`;
                        }
                    } catch (error) {
                        result += `ğŸ’¥ ${endpoint}: Erreur - ${error.message}\n`;
                    }
                }

                // Test 2: VÃ©rifier l'accÃ¨s aux endpoints utilisateur
                result += `\nğŸ” Test 2: AccÃ¨s aux endpoints utilisateur\n`;
                
                const userEndpoints = [
                    '/api/demandes',
                    '/api/demandes/my'
                ];

                for (const endpoint of userEndpoints) {
                    try {
                        const response = await fetch(`http://127.0.0.1:8080${endpoint}`, {
                            headers: {
                                'Authorization': `Bearer ${currentToken}`
                            }
                        });
                        
                        if (response.status === 200 || response.status === 201) {
                            result += `âœ… ${endpoint}: AccÃ¨s autorisÃ©\n`;
                        } else if (response.status === 403) {
                            result += `âŒ ${endpoint}: AccÃ¨s refusÃ© (problÃ¨me d'autorisation)\n`;
                        } else {
                            result += `âš ï¸ ${endpoint}: ${response.status} ${response.statusText}\n`;
                        }
                    } catch (error) {
                        result += `ğŸ’¥ ${endpoint}: Erreur - ${error.message}\n`;
                    }
                }

                showResult('securityDiagnostic', 'info', result);
                log('ğŸ‘‘ VÃ©rification des autoritÃ©s terminÃ©e', 'info');

            } catch (error) {
                log(`âŒ Erreur lors de la vÃ©rification des autoritÃ©s: ${error.message}`, 'error');
                showResult('securityDiagnostic', 'error', `âŒ Erreur lors de la vÃ©rification des autoritÃ©s: ${error.message}`);
            }
        }

        async function checkDatabaseStructure() {
            try {
                log('ğŸ—„ï¸ VÃ©rification de la structure de la base de donnÃ©es...', 'info');
                
                let result = `ğŸ—„ï¸ Structure de la Base de DonnÃ©es\n\n`;
                
                // Test 1: VÃ©rifier l'accÃ¨s aux donnÃ©es de rÃ©fÃ©rence
                result += `ğŸ” Test 1: DonnÃ©es de rÃ©fÃ©rence\n`;
                
                try {
                    const civilitesResponse = await fetch('http://127.0.0.1:8080/api/demandes/civilites');
                    if (civilitesResponse.ok) {
                        const civilites = await civilitesResponse.json();
                        result += `âœ… CivilitÃ©s: ${civilites.length} enregistrements trouvÃ©s\n`;
                    } else {
                        result += `âŒ CivilitÃ©s: ${civilitesResponse.status} ${civilitesResponse.statusText}\n`;
                    }
                } catch (error) {
                    result += `ğŸ’¥ CivilitÃ©s: Erreur - ${error.message}\n`;
                }

                try {
                    const paysResponse = await fetch('http://127.0.0.1:8080/api/demandes/pays');
                    if (paysResponse.ok) {
                        const pays = await paysResponse.json();
                        result += `âœ… Pays: ${pays.length} enregistrements trouvÃ©s\n`;
                    } else {
                        result += `âŒ Pays: ${paysResponse.status} ${paysResponse.statusText}\n`;
                    }
                } catch (error) {
                    result += `ğŸ’¥ Pays: Erreur - ${error.message}\n`;
                }

                try {
                    const typesResponse = await fetch('http://127.0.0.1:8080/api/demandes/document-types');
                    if (typesResponse.ok) {
                        const types = await typesResponse.json();
                        result += `âœ… Types de documents: ${types.length} enregistrements trouvÃ©s\n`;
                    } else {
                        result += `âŒ Types de documents: ${typesResponse.status} ${typesResponse.statusText}\n`;
                    }
                } catch (error) {
                    result += `ğŸ’¥ Types de documents: Erreur - ${error.message}\n`;
                }

                showResult('databaseDiagnostic', 'info', result);
                log('ğŸ—„ï¸ VÃ©rification de la structure terminÃ©e', 'info');

            } catch (error) {
                log(`âŒ Erreur lors de la vÃ©rification de la base: ${error.message}`, 'error');
                showResult('databaseDiagnostic', 'error', `âŒ Erreur lors de la vÃ©rification de la base: ${error.message}`);
            }
        }

        async function checkUserInDatabase() {
            if (!currentToken) {
                showResult('databaseDiagnostic', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ‘¤ VÃ©rification de l\'utilisateur en base...', 'info');
                
                let result = `ğŸ‘¤ Utilisateur en Base de DonnÃ©es\n\n`;
                result += `ğŸ“§ Email: ${currentUser.email}\n`;
                result += `ğŸ‘‘ RÃ´le: ${currentUser.role}\n\n`;

                // Test 1: VÃ©rifier l'endpoint /api/auth/me
                try {
                    const meResponse = await fetch('http://127.0.0.1:8080/api/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        }
                    });
                    
                    if (meResponse.ok) {
                        const meData = await meResponse.json();
                        result += `âœ… Endpoint /api/auth/me accessible\n`;
                        result += `â€¢ ID: ${meData.id || 'N/A'}\n`;
                        result += `â€¢ PrÃ©nom: ${meData.firstName || 'N/A'}\n`;
                        result += `â€¢ Nom: ${meData.lastName || 'N/A'}\n`;
                        result += `â€¢ Email vÃ©rifiÃ©: ${meData.emailVerified || 'N/A'}\n`;
                        result += `â€¢ Compte actif: ${meData.enabled || 'N/A'}\n`;
                        result += `â€¢ AutoritÃ©s: ${JSON.stringify(meData.authorities || [], null, 2)}\n`;
                    } else {
                        result += `âŒ Endpoint /api/auth/me: ${meResponse.status} ${meResponse.statusText}\n`;
                    }
                } catch (error) {
                    result += `ğŸ’¥ Endpoint /api/auth/me: Erreur - ${error.message}\n`;
                }

                // Test 2: VÃ©rifier l'accÃ¨s aux demandes de l'utilisateur
                try {
                    const myDemandesResponse = await fetch('http://127.0.0.1:8080/api/demandes/my', {
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        }
                    });
                    
                    if (myDemandesResponse.ok) {
                        const demandes = await myDemandesResponse.json();
                        result += `\nâœ… Endpoint /api/demandes/my accessible\n`;
                        result += `â€¢ Nombre de demandes: ${demandes.length}\n`;
                    } else {
                        result += `\nâŒ Endpoint /api/demandes/my: ${myDemandesResponse.status} ${myDemandesResponse.statusText}\n`;
                    }
                } catch (error) {
                    result += `\nğŸ’¥ Endpoint /api/demandes/my: Erreur - ${error.message}\n`;
                }

                showResult('databaseDiagnostic', 'info', result);
                log('ğŸ‘¤ VÃ©rification de l\'utilisateur terminÃ©e', 'info');

            } catch (error) {
                log(`âŒ Erreur lors de la vÃ©rification de l'utilisateur: ${error.message}`, 'error');
                showResult('databaseDiagnostic', 'error', `âŒ Erreur lors de la vÃ©rification de l'utilisateur: ${error.message}`);
            }
        }

        async function applyFixes() {
            try {
                log('ğŸ”§ Application des corrections...', 'info');
                
                let result = `ğŸ”§ Corrections AppliquÃ©es\n\n`;
                
                // Correction 1: VÃ©rifier la configuration de sÃ©curitÃ©
                result += `ğŸ” Correction 1: Configuration de sÃ©curitÃ©\n`;
                result += `â€¢ VÃ©rifier que l'endpoint /api/demandes est configurÃ© pour les utilisateurs authentifiÃ©s\n`;
                result += `â€¢ VÃ©rifier que le rÃ´le USER a les bonnes autorisations\n\n`;
                
                // Correction 2: VÃ©rifier le filtre JWT
                result += `ğŸ” Correction 2: Filtre JWT\n`;
                result += `â€¢ VÃ©rifier que le token est correctement extrait et validÃ©\n`;
                result += `â€¢ VÃ©rifier que l'utilisateur est correctement chargÃ©\n\n`;
                
                // Correction 3: VÃ©rifier la base de donnÃ©es
                result += `ğŸ” Correction 3: Base de donnÃ©es\n`;
                result += `â€¢ VÃ©rifier que l'utilisateur existe et est actif\n`;
                result += `â€¢ VÃ©rifier que les relations entre entitÃ©s sont correctes\n\n`;
                
                // Correction 4: RedÃ©marrer le backend
                result += `ğŸ” Correction 4: RedÃ©marrage\n`;
                result += `â€¢ RedÃ©marrer le backend pour appliquer les changements\n`;
                result += `â€¢ VÃ©rifier les logs du backend pour identifier les erreurs\n`;
                
                showResult('resolutionResult', 'info', result);
                log('ğŸ”§ Corrections appliquÃ©es', 'info');

            } catch (error) {
                log(`âŒ Erreur lors de l'application des corrections: ${error.message}`, 'error');
                showResult('resolutionResult', 'error', `âŒ Erreur lors de l'application des corrections: ${error.message}`);
            }
        }

        async function restartBackend() {
            try {
                log('ğŸ”„ RedÃ©marrage du backend...', 'info');
                
                let result = `ğŸ”„ RedÃ©marrage du Backend\n\n`;
                result += `ğŸ“‹ Instructions:\n`;
                result += `1. ArrÃªter le backend (Ctrl+C dans le terminal)\n`;
                result += `2. VÃ©rifier que le port 8080 est libre\n`;
                result += `3. RedÃ©marrer avec: mvn spring-boot:run\n`;
                result += `4. VÃ©rifier les logs de dÃ©marrage\n`;
                result += `5. Tester Ã  nouveau la crÃ©ation de demande\n\n`;
                
                result += `ğŸ” VÃ©rifications aprÃ¨s redÃ©marrage:\n`;
                result += `â€¢ Backend accessible sur http://127.0.0.1:8080\n`;
                result += `â€¢ Endpoints de santÃ© accessibles\n`;
                result += `â€¢ Base de donnÃ©es connectÃ©e\n`;
                result += `â€¢ Configuration de sÃ©curitÃ© chargÃ©e\n`;
                
                showResult('resolutionResult', 'info', result);
                log('ğŸ”„ Instructions de redÃ©marrage affichÃ©es', 'info');

            } catch (error) {
                log(`âŒ Erreur lors de l'affichage des instructions: ${error.message}`, 'error');
                showResult('resolutionResult', 'error', `âŒ Erreur lors de l'affichage des instructions: ${error.message}`);
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('ğŸ—‘ï¸ Logs effacÃ©s', 'warning');
        }

        // Initialisation
        log('ğŸš€ Diagnostic erreur 403 dÃ©marrÃ©', 'info');
        log('ğŸ’¡ Connectez-vous d\'abord, puis lancez les tests de diagnostic', 'info');
    </script>
</body>
</html>
