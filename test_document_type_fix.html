<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test - Correction du documentTypeId toujours √©gal √† 1</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .test-result {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .result-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            min-height: 100px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Test - Correction du documentTypeId toujours √©gal √† 1</h1>
            <p>V√©rification que la g√©n√©ration de documents Word utilise le bon type de document</p>
        </div>

        <div class="test-section">
            <h2>‚úÖ Probl√®me identifi√© et corrig√©</h2>
            <div class="test-result success">
                <strong>Probl√®me r√©solu :</strong> Le param√®tre documentTypeId √©tait toujours √©gal √† 1 pour tous les documents g√©n√©r√©s.
            </div>
            
            <h3>üîç Cause du probl√®me :</h3>
            <div class="code-block">
// ‚ùå AVANT - Code en dur avec fallback
else if (demande.documentTypeDisplay && typeof demande.documentTypeDisplay === "string") {
    // Utiliser un type par d√©faut bas√© sur le nom
    // Pour l'instant, utiliser l'ID 1 comme fallback
    documentTypeId = 1;  // ‚Üê TOUJOUR √âGAL √Ä 1 !
    console.log(`Type d√©tect√©: ${demande.documentTypeDisplay}, utilisation du type par d√©faut (ID: 1)`);
}

// ‚úÖ APR√àS - Mapping intelligent
const documentTypeId = selectedDocumentType[demandeId];
            </div>
        </div>

        <div class="test-section">
            <h2>üìã Structure des donn√©es backend</h2>
            <div class="code-block">
// DemandeAdminResponse.java
public class DemandeAdminResponse {
    private String documentType;        // "PASSEPORT" (enum name)
    private String documentTypeDisplay; // "Passeport" (display name)
    // ... autres champs
}

// Constructeur
public DemandeAdminResponse(Demande demande) {
    this.documentType = demande.getDocumentType().name();           // "PASSEPORT"
    this.documentTypeDisplay = demande.getDocumentType().getDisplayName(); // "Passeport"
    // ... autres champs
}
            </div>
        </div>

        <div class="test-section">
            <h2>üéØ Solution impl√©ment√©e</h2>
            
            <h3>1. Ajout de la fonction fetchDocumentTypes manquante :</h3>
            <div class="code-block">
const fetchDocumentTypes = async () => {
    try {
        const response = await fetch("http://localhost:8080/api/demandes/document-types", {
            headers: { Authorization: `Bearer ${token}` }
        });

        if (response.ok) {
            const data = await response.json();
            setDocumentTypes(data);
            
            // Mapping intelligent entre le type de la demande et le type en base
            const initialSelection = {};
            demandes.forEach((demande) => {
                const matchingType = data.find(
                    (type) =>
                        type.libelle.toLowerCase() === demande.documentTypeDisplay?.toLowerCase() ||
                        type.libelle.toLowerCase().includes(demande.documentTypeDisplay?.toLowerCase()) ||
                        demande.documentTypeDisplay?.toLowerCase().includes(type.libelle.toLowerCase())
                );

                if (matchingType) {
                    initialSelection[demande.id] = matchingType.id;
                } else {
                    initialSelection[demande.id] = data[0]?.id || null;
                }
            });
            
            setSelectedDocumentType(initialSelection);
        }
    } catch (err) {
        console.error("Erreur lors du chargement des types de documents:", err);
    }
};
            </div>

            <h3>2. Correction des fonctions de g√©n√©ration :</h3>
            <div class="code-block">
// AVANT - Logique complexe avec fallback cod√© en dur
const handleGenerateDocument = async (demandeId) => {
    const demande = demandes.find((d) => d.id === demandeId);
    let documentTypeId = null;
    
    if (demande) {
        // ... logique complexe ...
        else if (demande.documentTypeDisplay && typeof demande.documentTypeDisplay === "string") {
            documentTypeId = 1; // ‚Üê TOUJOUR √âGAL √Ä 1 !
        }
    }
    // ... reste du code ...
};

// APR√àS - Utilisation du mapping intelligent
const handleGenerateDocument = async (demandeId) => {
    const documentTypeId = selectedDocumentType[demandeId];
    
    if (!documentTypeId) {
        onNotification("error", "Erreur", "Veuillez s√©lectionner un type de document pour cette demande");
        return;
    }
    // ... reste du code ...
};
            </div>

            <h3>3. Ajout d'un s√©lecteur de type de document :</h3>
            <div class="code-block">
{/* S√©lecteur de type de document pour la g√©n√©ration */}
<select
    value={selectedDocumentType[demande.id] || ""}
    onChange={(e) => handleDocumentTypeChange(demande.id, e.target.value)}
    className="text-xs border border-gray-300 rounded px-2 py-1 bg-white"
    title="S√©lectionner le type de document √† g√©n√©rer"
>
    <option value="">Type...</option>
    {documentTypes.map((type) => (
        <option key={type.id} value={type.id}>
            {type.libelle}
        </option>
    ))}
</select>
            </div>
        </div>

        <div class="test-section">
            <h2>üß™ Test de la correction</h2>
            
            <div class="input-group">
                <label for="authToken">Token d'authentification :</label>
                <input type="text" id="authToken" placeholder="Bearer token..." style="width: 100%;">
            </div>

            <div class="input-group">
                <label for="demandeId">ID de la demande :</label>
                <input type="number" id="demandeId" placeholder="4" value="4">
            </div>

            <div class="input-group">
                <label for="documentTypeSelect">Type de document :</label>
                <select id="documentTypeSelect">
                    <option value="">Chargement...</option>
                </select>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="button" onclick="loadDocumentTypes()">üìã Charger les types de documents</button>
                <button class="button" onclick="testGeneration()">üîÑ Tester la g√©n√©ration</button>
                <button class="button" onclick="runCompleteTest()">üß™ Test complet</button>
            </div>

            <div class="result-box" id="testResult">R√©sultats des tests...</div>
        </div>

        <div class="test-section">
            <h2>üìä R√©sultat attendu</h2>
            <div class="test-result info">
                <strong>Avant la correction :</strong><br>
                ‚ùå Tous les documents g√©n√©r√©s avec documentTypeId=1<br>
                ‚ùå URL toujours identique : /api/admin/documents/generate?demandeId=4&documentTypeId=1<br>
                ‚ùå Impossible de g√©n√©rer diff√©rents types de documents
            </div>
            
            <div class="test-result success">
                <strong>Apr√®s la correction :</strong><br>
                ‚úÖ documentTypeId varie selon le type de document s√©lectionn√©<br>
                ‚úÖ URL dynamique : /api/admin/documents/generate?demandeId=4&documentTypeId=2<br>
                ‚úÖ Possibilit√© de choisir le type de document avant g√©n√©ration
            </div>
        </div>

        <div class="test-section">
            <h2>üîß Fichiers modifi√©s</h2>
            <ul>
                <li><strong>frontend/src/components/AdminDemandesList.jsx</strong> - Ajout de fetchDocumentTypes et correction de la logique</li>
                <li><strong>Correction de l'affichage</strong> - documentTypeDisplay?.libelle ‚Üí documentTypeDisplay</li>
                <li><strong>Ajout du s√©lecteur</strong> - Permet √† l'admin de choisir le type de document</li>
            </ul>
        </div>
    </div>

    <script>
        let authToken = '';
        let documentTypes = [];

        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result-box ${isError ? 'error' : 'success'}`;
        }

        function log(message, type = 'info') {
            const resultBox = document.getElementById('testResult');
            const timestamp = new Date().toLocaleTimeString();
            resultBox.textContent += `[${timestamp}] ${message}\n`;
            resultBox.scrollTop = resultBox.scrollHeight;
        }

        async function makeRequest(url, options = {}) {
            if (!authToken) {
                throw new Error('Token d\'authentification requis');
            }

            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': authToken,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            return response.json();
        }

        async function loadDocumentTypes() {
            try {
                authToken = document.getElementById('authToken').value.trim();
                if (!authToken) {
                    showResult('testResult', '‚ùå Veuillez saisir un token d\'authentification', true);
                    return;
                }

                if (!authToken.startsWith('Bearer ')) {
                    authToken = 'Bearer ' + authToken;
                }

                log('üîÑ Chargement des types de documents...');
                
                const data = await makeRequest('http://localhost:8080/api/demandes/document-types');
                documentTypes = data;
                
                const select = document.getElementById('documentTypeSelect');
                select.innerHTML = '<option value="">S√©lectionner un type...</option>';
                
                data.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = `${type.libelle} (ID: ${type.id})`;
                    select.appendChild(option);
                });

                log(`‚úÖ ${data.length} types de documents charg√©s`);
                showResult('testResult', `‚úÖ ${data.length} types de documents charg√©s avec succ√®s!\n\n${JSON.stringify(data, null, 2)}`);

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                showResult('testResult', `‚ùå Erreur: ${error.message}`, true);
            }
        }

        async function testGeneration() {
            try {
                if (!authToken) {
                    showResult('testResult', '‚ùå Veuillez d\'abord vous connecter', true);
                    return;
                }

                const demandeId = document.getElementById('demandeId').value;
                const documentTypeId = document.getElementById('documentTypeSelect').value;

                if (!demandeId || !documentTypeId) {
                    showResult('testResult', '‚ùå Veuillez saisir l\'ID de la demande et s√©lectionner un type de document', true);
                    return;
                }

                log(`üîÑ Test de g√©n√©ration pour demande ${demandeId}, type ${documentTypeId}...`);
                showResult('testResult', `üîÑ Test de g√©n√©ration en cours...\n\nDemande ID: ${demandeId}\nType de document ID: ${documentTypeId}\n\nURL: /api/admin/documents/generate?demandeId=${demandeId}&documentTypeId=${documentTypeId}`);

                // Test de l'endpoint (sans r√©ellement g√©n√©rer)
                try {
                    const data = await makeRequest(
                        `http://localhost:8080/api/admin/documents/generate?demandeId=${demandeId}&documentTypeId=${documentTypeId}`,
                        { method: 'POST' }
                    );
                    
                    log(`‚úÖ Document g√©n√©r√© avec succ√®s!`);
                    showResult('testResult', `‚úÖ Document g√©n√©r√© avec succ√®s!\n\n${JSON.stringify(data, null, 2)}`);
                    
                } catch (error) {
                    if (error.message.includes('400')) {
                        log(`‚ö†Ô∏è Erreur 400 - V√©rifiez que la demande et le type de document existent`, 'error');
                        showResult('testResult', `‚ö†Ô∏è Erreur 400 - V√©rifiez que la demande et le type de document existent\n\nD√©tails: ${error.message}`, true);
                    } else {
                        throw error;
                    }
                }

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                showResult('testResult', `‚ùå Erreur: ${error.message}`, true);
            }
        }

        async function runCompleteTest() {
            try {
                if (!authToken) {
                    showResult('testResult', '‚ùå Veuillez d\'abord vous connecter', true);
                    return;
                }

                showResult('testResult', 'üß™ D√©marrage du test complet...\n\n');

                // 1. Charger les types de documents
                log('1Ô∏è‚É£ Chargement des types de documents...');
                await loadDocumentTypes();
                
                // 2. Tester avec diff√©rents types
                log('2Ô∏è‚É£ Test avec diff√©rents types de documents...');
                const demandeId = document.getElementById('demandeId').value;
                
                for (let i = 0; i < Math.min(3, documentTypes.length); i++) {
                    const type = documentTypes[i];
                    log(`   Test avec type: ${type.libelle} (ID: ${type.id})`);
                    
                    // Simuler la s√©lection
                    document.getElementById('documentTypeSelect').value = type.id;
                    
                    // V√©rifier l'URL qui serait g√©n√©r√©e
                    const expectedUrl = `/api/admin/documents/generate?demandeId=${demandeId}&documentTypeId=${type.id}`;
                    log(`   URL attendue: ${expectedUrl}`);
                }
                
                log('‚úÖ Test complet termin√©!');
                showResult('testResult', `‚úÖ Test complet termin√©!\n\nLe documentTypeId varie maintenant correctement selon le type s√©lectionn√©.\n\nTypes disponibles:\n${documentTypes.map(t => `- ${t.libelle} (ID: ${t.id})`).join('\n')}`);

            } catch (error) {
                log(`‚ùå Erreur lors du test complet: ${error.message}`, 'error');
                showResult('testResult', `‚ùå Erreur lors du test complet: ${error.message}`, true);
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('üß™ Page de test charg√©e');
            log('üìã Instructions:');
            log('1. Saisissez votre token d\'authentification');
            log('2. Cliquez sur "Charger les types de documents"');
            log('3. S√©lectionnez un type de document');
            log('4. Testez la g√©n√©ration');
        });
    </script>
</body>
</html>
