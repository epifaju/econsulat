<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug CrÃ©ation Demande - eConsulat</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 6px; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        .info { border-color: #17a2b8; background: #d1ecf1; }
        .form-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 15px; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; max-height: 400px; overflow-y: auto; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        .status.warning { background: #ffc107; color: black; }
        .debug-info { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .step { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Debug CrÃ©ation Demande - eConsulat</h1>
        
        <div class="section info">
            <h3>ğŸ¯ Objectif du debug</h3>
            <p>Identifier pourquoi la crÃ©ation de demande ne fonctionne plus aprÃ¨s les corrections de l'erreur 403.</p>
            <p><strong>ProblÃ¨me :</strong> La demande n'est plus crÃ©Ã©e, probablement Ã  cause des modifications de sÃ©curitÃ©</p>
        </div>

        <!-- Section Connexion -->
        <div class="section">
            <h3>ğŸ”‘ Ã‰tape 1: Connexion et obtention du token</h3>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="votre@email.com" value="test@test.com">
            </div>
            <div class="form-group">
                <label for="password">Mot de passe:</label>
                <input type="password" id="password" placeholder="Mot de passe" value="password123">
            </div>
            <button onclick="login()">ğŸ” Se connecter</button>
            <div id="loginResult" class="result"></div>
        </div>

        <!-- Section Diagnostic Token -->
        <div class="section">
            <h3>ğŸ” Ã‰tape 2: Diagnostic complet du token et des autoritÃ©s</h3>
            <button onclick="diagnoseTokenComplete()">ğŸ” Diagnostic complet du token</button>
            <button onclick="testTokenValidation()">âœ… Tester la validation du token</button>
            <button onclick="checkUserAuthorities()">ğŸ‘‘ VÃ©rifier les autoritÃ©s utilisateur</button>
            <div id="tokenDiagnostic" class="result"></div>
        </div>

        <!-- Section Test Endpoints -->
        <div class="section">
            <h3>ğŸŒ Ã‰tape 3: Test des endpoints de demandes</h3>
            <button onclick="testEndpoints()">ğŸ§ª Tester tous les endpoints</button>
            <button onclick="testCreateDemandeStepByStep()">ğŸ“ Test crÃ©ation Ã©tape par Ã©tape</button>
            <div id="endpointsTest" class="result"></div>
        </div>

        <!-- Section Analyse Erreur -->
        <div class="section">
            <h3>ğŸš¨ Ã‰tape 4: Analyse des erreurs et logs</h3>
            <button onclick="analyzeErrors()">ğŸ”¬ Analyser les erreurs</button>
            <button onclick="checkSecurityContext()">ğŸ” VÃ©rifier le contexte de sÃ©curitÃ©</button>
            <div id="errorAnalysis" class="result"></div>
        </div>

        <!-- Section Logs -->
        <div class="section">
            <h3>ğŸ“Š Logs de diagnostic</h3>
            <button onclick="clearLogs()">ğŸ—‘ï¸ Effacer les logs</button>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUser = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logsDiv.innerHTML += `[${timestamp}] <span class="status ${statusClass}">${type.toUpperCase()}</span> ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showResult('loginResult', 'error', 'âŒ Veuillez remplir tous les champs');
                return;
            }

            try {
                log('ğŸ” Tentative de connexion...', 'info');
                
                const response = await fetch('http://127.0.0.1:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                log(`ğŸ“¡ RÃ©ponse du serveur: ${response.status} ${response.statusText}`, 'info');

                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    currentUser = data;
                    
                    log('âœ… Connexion rÃ©ussie!', 'success');
                    log(`ğŸ‘¤ Utilisateur: ${data.email}`, 'info');
                    log(`ğŸ”‘ Token reÃ§u: ${data.token ? 'Oui' : 'Non'}`, 'info');
                    log(`ğŸ‘‘ RÃ´le: ${data.role}`, 'info');
                    
                    showResult('loginResult', 'success', 
                        `âœ… Connexion rÃ©ussie!\n` +
                        `ğŸ‘¤ Email: ${data.email}\n` +
                        `ğŸ‘‘ RÃ´le: ${data.role}\n` +
                        `ğŸ”‘ Token: ${data.token ? 'ReÃ§u' : 'Manquant'}`);
                } else {
                    const errorData = await response.text();
                    log(`âŒ Erreur de connexion: ${response.status} - ${errorData}`, 'error');
                    showResult('loginResult', 'error', `âŒ Erreur de connexion: ${response.status} - ${errorData}`);
                }
            } catch (error) {
                log(`âŒ Erreur de connexion: ${error.message}`, 'error');
                showResult('loginResult', 'error', `âŒ Erreur de connexion: ${error.message}`);
            }
        }

        function diagnoseTokenComplete() {
            if (!currentToken) {
                showResult('tokenDiagnostic', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                const tokenParts = currentToken.split('.');
                if (tokenParts.length !== 3) {
                    showResult('tokenDiagnostic', 'error', 'âŒ Format de token invalide');
                    return;
                }

                const header = JSON.parse(atob(tokenParts[0]));
                const payload = JSON.parse(atob(tokenParts[1]));
                const expiration = new Date(payload.exp * 1000);
                const now = new Date();

                let message = `ğŸ” Diagnostic complet du token JWT:\n\n`;
                message += `ğŸ“‹ Header: ${JSON.stringify(header, null, 2)}\n\n`;
                message += `ğŸ“‹ Payload: ${JSON.stringify(payload, null, 2)}\n\n`;
                message += `â° Expiration: ${expiration.toLocaleString()}\n`;
                message += `ğŸ• Maintenant: ${now.toLocaleString()}\n`;
                message += `ğŸ‘¤ Sujet: ${payload.sub}\n`;
                message += `ğŸ”‘ Type: ${payload.typ || 'N/A'}\n`;
                message += `ğŸ“ Algorithme: ${header.alg || 'N/A'}\n`;

                if (expiration < now) {
                    message += `\nâŒ TOKEN EXPIRÃ‰!`;
                    showResult('tokenDiagnostic', 'error', message);
                } else if (expiration - now < 5 * 60 * 1000) {
                    message += `\nâš ï¸ Token expire bientÃ´t!`;
                    showResult('tokenDiagnostic', 'warning', message);
                } else {
                    message += `\nâœ… Token valide`;
                    showResult('tokenDiagnostic', 'success', message);
                }
                
                log(`ğŸ” Token diagnostiquÃ©: ${payload.sub}`, 'info');
            } catch (error) {
                showResult('tokenDiagnostic', 'error', `âŒ Erreur lors du diagnostic: ${error.message}`);
                log(`âŒ Erreur diagnostic: ${error.message}`, 'error');
            }
        }

        async function testTokenValidation() {
            if (!currentToken) {
                showResult('tokenDiagnostic', 'error', 'âŒ Aucun token Ã  valider. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ” Validation du token...', 'info');
                
                const response = await fetch('http://127.0.0.1:8080/api/demandes/my', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                log(`ğŸ“¡ RÃ©ponse validation: ${response.status} ${response.statusText}`, 'info');

                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Token valide!', 'success');
                    log(`ğŸ“Š Nombre de demandes: ${data.length}`, 'info');
                    
                    showResult('tokenDiagnostic', 'success', 
                        `âœ… Token valide!\n` +
                        `ğŸ“Š Nombre de demandes: ${data.length}\n` +
                        `ğŸ”“ AccÃ¨s autorisÃ© Ã  l'API`);
                } else if (response.status === 403) {
                    log('âŒ Token invalide ou expirÃ© (403 Forbidden)', 'error');
                    showResult('tokenDiagnostic', 'error', 
                        `âŒ Token invalide ou expirÃ©\n` +
                        `ğŸš« AccÃ¨s refusÃ© (403 Forbidden)\n` +
                        `ğŸ’¡ VÃ©rifiez la validitÃ© du token`);
                } else {
                    const errorData = await response.text();
                    log(`âŒ Erreur de validation: ${response.status} - ${errorData}`, 'error');
                    showResult('tokenDiagnostic', 'error', `âŒ Erreur de validation: ${response.status} - ${errorData}`);
                }
            } catch (error) {
                log(`âŒ Erreur de validation: ${error.message}`, 'error');
                showResult('tokenDiagnostic', 'error', `âŒ Erreur de validation: ${error.message}`);
            }
        }

        async function checkUserAuthorities() {
            if (!currentToken) {
                showResult('tokenDiagnostic', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ‘‘ VÃ©rification des autoritÃ©s utilisateur...', 'info');
                
                // Test de diffÃ©rents endpoints pour vÃ©rifier les autoritÃ©s
                const endpoints = [
                    { name: 'Mes demandes', url: '/api/demandes/my', method: 'GET' },
                    { name: 'Types de documents', url: '/api/demandes/document-types', method: 'GET' },
                    { name: 'CivilitÃ©s', url: '/api/demandes/civilites', method: 'GET' },
                    { name: 'Pays', url: '/api/demandes/pays', method: 'GET' }
                ];

                let results = `ğŸ‘‘ Test des autoritÃ©s utilisateur:\n\n`;
                let hasAccess = true;

                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(`http://127.0.0.1:8080${endpoint.url}`, {
                            method: endpoint.method,
                            headers: { 'Authorization': `Bearer ${currentToken}` }
                        });

                        const status = response.status;
                        const statusText = response.statusText;
                        
                        results += `${endpoint.name} (${endpoint.method} ${endpoint.url}): ${status} ${statusText}\n`;
                        
                        if (response.ok) {
                            log(`âœ… ${endpoint.name}: ${status}`, 'success');
                        } else if (response.status === 403) {
                            log(`âŒ ${endpoint.name}: ${status} (Forbidden)`, 'error');
                            hasAccess = false;
                        } else {
                            log(`âš ï¸ ${endpoint.name}: ${status}`, 'warning');
                        }
                    } catch (error) {
                        results += `${endpoint.name}: Erreur de connexion\n`;
                        log(`âŒ ${endpoint.name}: Erreur de connexion`, 'error');
                        hasAccess = false;
                    }
                }

                if (hasAccess) {
                    results += `\nâœ… L'utilisateur a accÃ¨s aux endpoints de base`;
                    showResult('tokenDiagnostic', 'success', results);
                } else {
                    results += `\nâŒ L'utilisateur n'a pas accÃ¨s Ã  tous les endpoints`;
                    showResult('tokenDiagnostic', 'error', results);
                }

                log('ğŸ‘‘ VÃ©rification des autoritÃ©s terminÃ©e', 'info');

            } catch (error) {
                log(`âŒ Erreur lors de la vÃ©rification des autoritÃ©s: ${error.message}`, 'error');
                showResult('tokenDiagnostic', 'error', `âŒ Erreur lors de la vÃ©rification des autoritÃ©s: ${error.message}`);
            }
        }

        async function testEndpoints() {
            if (!currentToken) {
                showResult('endpointsTest', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸŒ Test de tous les endpoints...', 'info');
                
                const endpoints = [
                    { name: 'GET /api/demandes', url: '/api/demandes', method: 'GET' },
                    { name: 'GET /api/demandes/my', url: '/api/demandes/my', method: 'GET' },
                    { name: 'GET /api/demandes/document-types', url: '/api/demandes/document-types', method: 'GET' },
                    { name: 'GET /api/demandes/civilites', url: '/api/demandes/civilites', method: 'GET' },
                    { name: 'GET /api/demandes/pays', url: '/api/demandes/pays', method: 'GET' },
                    { name: 'POST /api/demandes', url: '/api/demandes', method: 'POST' }
                ];

                let results = `ğŸŒ Test de tous les endpoints:\n\n`;

                for (const endpoint of endpoints) {
                    try {
                        let response;
                        if (endpoint.method === 'POST') {
                            // Pour POST, on envoie des donnÃ©es de test minimales
                            const testData = {
                                civiliteId: 1,
                                firstName: "Test",
                                lastName: "User",
                                birthDate: "1990-01-01",
                                birthPlace: "Test",
                                birthCountryId: 1,
                                streetName: "Test Street",
                                streetNumber: "123",
                                postalCode: "12345",
                                city: "Test City",
                                countryId: 1,
                                fatherFirstName: "Test",
                                fatherLastName: "Father",
                                fatherBirthDate: "1960-01-01",
                                fatherBirthPlace: "Test",
                                fatherBirthCountryId: 1,
                                motherFirstName: "Test",
                                motherLastName: "Mother",
                                motherBirthDate: "1965-01-01",
                                motherBirthPlace: "Test",
                                motherBirthCountryId: 1,
                                documentTypeId: 1,
                                documentFiles: []
                            };

                            response = await fetch(`http://127.0.0.1:8080${endpoint.url}`, {
                                method: endpoint.method,
                                headers: {
                                    'Authorization': `Bearer ${currentToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(testData)
                            });
                        } else {
                            response = await fetch(`http://127.0.0.1:8080${endpoint.url}`, {
                                method: endpoint.method,
                                headers: { 'Authorization': `Bearer ${currentToken}` }
                            });
                        }

                        const status = response.status;
                        const statusText = response.statusText;
                        
                        results += `${endpoint.name}: ${status} ${statusText}\n`;
                        
                        if (response.ok) {
                            log(`âœ… ${endpoint.name}: ${status}`, 'success');
                        } else if (response.status === 403) {
                            log(`âŒ ${endpoint.name}: ${status} (Forbidden)`, 'error');
                        } else {
                            log(`âš ï¸ ${endpoint.name}: ${status}`, 'warning');
                        }
                    } catch (error) {
                        results += `${endpoint.name}: Erreur de connexion\n`;
                        log(`âŒ ${endpoint.name}: Erreur de connexion`, 'error');
                    }
                }

                showResult('endpointsTest', 'info', results);
                log('ğŸŒ Test des endpoints terminÃ©', 'info');

            } catch (error) {
                log(`âŒ Erreur lors du test des endpoints: ${error.message}`, 'error');
                showResult('endpointsTest', 'error', `âŒ Erreur lors du test des endpoints: ${error.message}`);
            }
        }

        async function testCreateDemandeStepByStep() {
            if (!currentToken) {
                showResult('endpointsTest', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ“ Test crÃ©ation demande Ã©tape par Ã©tape...', 'info');
                
                // Ã‰tape 1: VÃ©rifier l'accÃ¨s aux donnÃ©es de rÃ©fÃ©rence
                log('ğŸ“ Ã‰tape 1: VÃ©rification des donnÃ©es de rÃ©fÃ©rence', 'info');
                
                const [civilitesRes, paysRes, typesRes] = await Promise.all([
                    fetch('http://127.0.0.1:8080/api/demandes/civilites', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch('http://127.0.0.1:8080/api/demandes/pays', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch('http://127.0.0.1:8080/api/demandes/document-types', {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    })
                ]);

                let step1Results = `ğŸ“ Ã‰tape 1: DonnÃ©es de rÃ©fÃ©rence\n`;
                step1Results += `â€¢ CivilitÃ©s: ${civilitesRes.status} ${civilitesRes.statusText}\n`;
                step1Results += `â€¢ Pays: ${paysRes.status} ${paysRes.statusText}\n`;
                step1Results += `â€¢ Types de documents: ${typesRes.status} ${typesRes.statusText}\n`;

                if (civilitesRes.ok && paysRes.ok && typesRes.ok) {
                    log('âœ… DonnÃ©es de rÃ©fÃ©rence accessibles', 'success');
                    step1Results += `\nâœ… Toutes les donnÃ©es de rÃ©fÃ©rence sont accessibles`;
                } else {
                    log('âŒ Certaines donnÃ©es de rÃ©fÃ©rence ne sont pas accessibles', 'error');
                    step1Results += `\nâŒ Certaines donnÃ©es de rÃ©fÃ©rence ne sont pas accessibles`;
                }

                // Ã‰tape 2: Tentative de crÃ©ation de demande
                log('ğŸ“ Ã‰tape 2: Tentative de crÃ©ation de demande', 'info');
                
                const testDemande = {
                    civiliteId: 1,
                    firstName: "Jean",
                    lastName: "Dupont",
                    birthDate: "1990-01-01",
                    birthPlace: "Paris",
                    birthCountryId: 1,
                    streetName: "Rue de la Paix",
                    streetNumber: "123",
                    boxNumber: "",
                    postalCode: "75001",
                    city: "Paris",
                    countryId: 1,
                    fatherFirstName: "Pierre",
                    fatherLastName: "Dupont",
                    fatherBirthDate: "1950-01-01",
                    fatherBirthPlace: "Lyon",
                    fatherBirthCountryId: 1,
                    motherFirstName: "Marie",
                    motherLastName: "Martin",
                    motherBirthDate: "1955-01-01",
                    motherBirthPlace: "Marseille",
                    motherBirthCountryId: 1,
                    documentTypeId: 1,
                    documentFiles: []
                };

                const createResponse = await fetch('http://127.0.0.1:8080/api/demandes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(testDemande)
                });

                let step2Results = `\nğŸ“ Ã‰tape 2: CrÃ©ation de demande\n`;
                step2Results += `â€¢ Statut: ${createResponse.status} ${createResponse.statusText}\n`;

                if (createResponse.ok) {
                    const data = await createResponse.json();
                    log('âœ… Demande crÃ©Ã©e avec succÃ¨s!', 'success');
                    step2Results += `â€¢ ID de la demande: ${data.id}\n`;
                    step2Results += `â€¢ Statut: ${data.status}\n`;
                    step2Results += `\nâœ… La crÃ©ation de demande fonctionne correctement!`;
                } else if (createResponse.status === 403) {
                    log('âŒ AccÃ¨s refusÃ© (403 Forbidden)', 'error');
                    step2Results += `\nâŒ AccÃ¨s refusÃ© (403 Forbidden)`;
                    
                    // Essayer de rÃ©cupÃ©rer plus d'informations sur l'erreur
                    try {
                        const errorData = await createResponse.text();
                        if (errorData) {
                            step2Results += `\nâ€¢ DÃ©tails de l'erreur: ${errorData}`;
                        }
                    } catch (parseError) {
                        step2Results += `\nâ€¢ RÃ©ponse vide (impossible de parser)`;
                    }
                } else {
                    log(`âŒ Erreur lors de la crÃ©ation: ${createResponse.status}`, 'error');
                    step2Results += `\nâŒ Erreur lors de la crÃ©ation: ${createResponse.status}`;
                    
                    try {
                        const errorData = await createResponse.text();
                        if (errorData) {
                            step2Results += `\nâ€¢ DÃ©tails de l'erreur: ${errorData}`;
                        }
                    } catch (parseError) {
                        step2Results += `\nâ€¢ RÃ©ponse vide (impossible de parser)`;
                    }
                }

                const finalResults = step1Results + step2Results;
                showResult('endpointsTest', 'info', finalResults);
                log('ğŸ“ Test crÃ©ation demande terminÃ©', 'info');

            } catch (error) {
                log(`âŒ Erreur lors du test de crÃ©ation: ${error.message}`, 'error');
                showResult('endpointsTest', 'error', `âŒ Erreur lors du test de crÃ©ation: ${error.message}`);
            }
        }

        async function analyzeErrors() {
            if (!currentToken) {
                showResult('errorAnalysis', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ”¬ Analyse des erreurs...', 'info');
                
                let analysis = `ğŸ”¬ Analyse des erreurs de crÃ©ation de demande:\n\n`;
                
                // Test 1: VÃ©rifier l'authentification
                analysis += `ğŸ” Test 1: VÃ©rification de l'authentification\n`;
                const authResponse = await fetch('http://127.0.0.1:8080/api/demandes/my', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                analysis += `â€¢ GET /api/demandes/my: ${authResponse.status} ${authResponse.statusText}\n`;
                
                if (authResponse.status === 403) {
                    analysis += `âŒ ProblÃ¨me d'authentification - L'utilisateur n'est pas reconnu\n`;
                } else if (authResponse.status === 200) {
                    analysis += `âœ… Authentification OK - L'utilisateur est reconnu\n`;
                }

                // Test 2: VÃ©rifier les autorisations
                analysis += `\nğŸ” Test 2: VÃ©rification des autorisations\n`;
                const createResponse = await fetch('http://127.0.0.1:8080/api/demandes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        civiliteId: 1,
                        firstName: "Test",
                        lastName: "User",
                        birthDate: "1990-01-01",
                        birthPlace: "Test",
                        birthCountryId: 1,
                        streetName: "Test Street",
                        streetNumber: "123",
                        postalCode: "12345",
                        city: "Test City",
                        countryId: 1,
                        fatherFirstName: "Test",
                        fatherLastName: "Father",
                        fatherBirthDate: "1960-01-01",
                        fatherBirthPlace: "Test",
                        fatherBirthCountryId: 1,
                        motherFirstName: "Test",
                        motherLastName: "Mother",
                        motherBirthDate: "1965-01-01",
                        motherBirthPlace: "Test",
                        motherBirthCountryId: 1,
                        documentTypeId: 1,
                        documentFiles: []
                    })
                });
                
                analysis += `â€¢ POST /api/demandes: ${createResponse.status} ${createResponse.statusText}\n`;
                
                if (createResponse.status === 403) {
                    analysis += `âŒ ProblÃ¨me d'autorisation - L'utilisateur n'a pas le droit de crÃ©er\n`;
                } else if (createResponse.status === 200) {
                    analysis += `âœ… Autorisation OK - L'utilisateur peut crÃ©er\n`;
                }

                // Test 3: VÃ©rifier la configuration CORS
                analysis += `\nğŸ” Test 3: VÃ©rification de la configuration CORS\n`;
                const corsResponse = await fetch('http://127.0.0.1:8080/api/demandes/civilites');
                analysis += `â€¢ GET /api/demandes/civilites (sans token): ${corsResponse.status} ${corsResponse.statusText}\n`;
                
                if (corsResponse.status === 200) {
                    analysis += `âœ… CORS OK - Les requÃªtes sans token sont autorisÃ©es\n`;
                } else {
                    analysis += `âŒ ProblÃ¨me CORS - Les requÃªtes sans token sont bloquÃ©es\n`;
                }

                // Diagnostic final
                analysis += `\nğŸ¯ DIAGNOSTIC FINAL:\n`;
                if (authResponse.status === 200 && createResponse.status === 200) {
                    analysis += `âœ… Tout fonctionne correctement!`;
                } else if (authResponse.status === 403) {
                    analysis += `ğŸš¨ PROBLÃˆME D'AUTHENTIFICATION\n`;
                    analysis += `â€¢ Le token JWT n'est pas valide ou expirÃ©\n`;
                    analysis += `â€¢ L'utilisateur n'est pas reconnu par le systÃ¨me\n`;
                } else if (createResponse.status === 403) {
                    analysis += `ğŸš¨ PROBLÃˆME D'AUTORISATION\n`;
                    analysis += `â€¢ L'utilisateur est authentifiÃ© mais n'a pas les droits\n`;
                    analysis += `â€¢ VÃ©rifiez le rÃ´le de l'utilisateur: ${currentUser?.role || 'Inconnu'}\n`;
                }

                showResult('errorAnalysis', 'info', analysis);
                log('ğŸ”¬ Analyse des erreurs terminÃ©e', 'info');

            } catch (error) {
                log(`âŒ Erreur lors de l'analyse: ${error.message}`, 'error');
                showResult('errorAnalysis', 'error', `âŒ Erreur lors de l'analyse: ${error.message}`);
            }
        }

        async function checkSecurityContext() {
            if (!currentToken) {
                showResult('errorAnalysis', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ” VÃ©rification du contexte de sÃ©curitÃ©...', 'info');
                
                // Test simple pour vÃ©rifier que le token est bien transmis
                const response = await fetch('http://127.0.0.1:8080/api/demandes/my', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'X-Debug-Token': 'true'
                    }
                });

                let results = `ğŸ” VÃ©rification du contexte de sÃ©curitÃ©:\n\n`;
                results += `â€¢ Token utilisÃ©: ${currentToken.substring(0, 20)}...\n`;
                results += `â€¢ RÃ©ponse du serveur: ${response.status} ${response.statusText}\n`;
                results += `â€¢ Headers de rÃ©ponse: ${JSON.stringify([...response.headers.entries()], null, 2)}\n`;

                if (response.ok) {
                    results += `\nâœ… Le contexte de sÃ©curitÃ© est correctement Ã©tabli`;
                } else {
                    results += `\nâŒ ProblÃ¨me avec le contexte de sÃ©curitÃ©`;
                }

                showResult('errorAnalysis', 'info', results);
                log('ğŸ” VÃ©rification du contexte de sÃ©curitÃ© terminÃ©e', 'info');

            } catch (error) {
                log(`âŒ Erreur lors de la vÃ©rification du contexte: ${error.message}`, 'error');
                showResult('errorAnalysis', 'error', `âŒ Erreur lors de la vÃ©rification du contexte: ${error.message}`);
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('ğŸ—‘ï¸ Logs effacÃ©s', 'warning');
        }

        // Initialisation
        log('ğŸš€ Debug crÃ©ation demande dÃ©marrÃ©', 'info');
        log('ğŸ’¡ Connectez-vous d\'abord, puis lancez les tests de diagnostic', 'info');
    </script>
</body>
</html>

