<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Mise à Jour Statut - Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Test Mise à Jour Statut - Debug Complet</h1>
        
        <div class="form-group">
            <label for="token">Token JWT (Admin/Agent):</label>
            <input type="text" id="token" placeholder="Collez votre token JWT ici" style="font-family: monospace; font-size: 12px;">
        </div>

        <div class="form-group">
            <label for="demandeId">ID de la Demande:</label>
            <input type="number" id="demandeId" value="4" placeholder="ID de la demande à mettre à jour">
        </div>

        <div class="form-group">
            <label for="newStatus">Nouveau Statut:</label>
            <select id="newStatus">
                <option value="EN_ATTENTE">En Attente</option>
                <option value="EN_COURS">En Cours</option>
                <option value="APPROUVEE">Approuvée</option>
                <option value="REJETEE">Rejetée</option>
                <option value="TERMINEE">Terminée</option>
            </select>
        </div>

        <div class="form-group">
            <button onclick="testStatusUpdate()">🔄 Tester la Mise à Jour de Statut</button>
            <button onclick="testAuth()">🔐 Tester l'Authentification</button>
            <button onclick="testUserInfo()">👤 Tester les Infos Utilisateur</button>
            <button onclick="clearLogs()">🗑️ Effacer les Logs</button>
        </div>

        <div class="log" id="logContainer">
            <h3>📋 Logs de Debug:</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8080/api';
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function getAuthHeaders() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                throw new Error('Token JWT requis');
            }
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        async function testAuth() {
            try {
                log('🔐 Test de l\'authentification...', 'info');
                
                const headers = getAuthHeaders();
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    headers: headers
                });

                log(`📡 Réponse Auth: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const userData = await response.json();
                    log(`✅ Utilisateur authentifié: ${userData.email}`, 'success');
                    log(`👤 Rôle: ${userData.role}`, 'success');
                    log(`🔓 Autorités: ${JSON.stringify(userData.authorities)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`❌ Erreur Auth: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`💥 Erreur lors du test d'auth: ${error.message}`, 'error');
            }
        }

        async function testUserInfo() {
            try {
                log('👤 Test des informations utilisateur...', 'info');
                
                const headers = getAuthHeaders();
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'GET',
                    headers: headers
                });

                log(`📡 Réponse Users: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const users = await response.json();
                    log(`✅ Liste des utilisateurs récupérée: ${users.length} utilisateurs`, 'success');
                    
                    // Afficher les utilisateurs admin/agent
                    const adminUsers = users.filter(u => u.role === 'ADMIN' || u.role === 'AGENT');
                    log(`👑 Utilisateurs Admin/Agent: ${adminUsers.length}`, 'info');
                    adminUsers.forEach(u => {
                        log(`   - ${u.email} (${u.role}) - Vérifié: ${u.emailVerified}`, 'info');
                    });
                } else {
                    const errorText = await response.text();
                    log(`❌ Erreur Users: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`💥 Erreur lors du test users: ${error.message}`, 'error');
            }
        }

        async function testStatusUpdate() {
            try {
                const demandeId = document.getElementById('demandeId').value;
                const newStatus = document.getElementById('newStatus').value;
                
                log(`🔄 Test de mise à jour du statut de la demande ${demandeId} vers ${newStatus}...`, 'info');
                
                const headers = getAuthHeaders();
                const payload = { status: newStatus };
                
                log(`📤 Payload: ${JSON.stringify(payload)}`, 'info');
                log(`🔑 Headers: ${JSON.stringify(headers)}`, 'info');
                
                const response = await fetch(`${API_BASE}/demandes/${demandeId}/status`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                log(`📡 Réponse Status Update: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    log(`✅ Statut mis à jour avec succès!`, 'success');
                    log(`📋 Détails: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`❌ Erreur Status Update: ${errorText}`, 'error');
                    
                    // Test des headers de réponse pour plus de détails
                    log(`📋 Headers de réponse:`, 'info');
                    response.headers.forEach((value, key) => {
                        log(`   ${key}: ${value}`, 'info');
                    });
                }
            } catch (error) {
                log(`💥 Erreur lors de la mise à jour: ${error.message}`, 'error');
            }
        }

        // Test automatique au chargement
        window.onload = function() {
            log('🚀 Page de test chargée. Prêt pour le diagnostic!', 'info');
            log('💡 Instructions:', 'info');
            log('   1. Collez votre token JWT d\'admin/agent', 'info');
            log('   2. Cliquez sur "Tester l\'Authentification"', 'info');
            log('   3. Cliquez sur "Tester les Infos Utilisateur"', 'info');
            log('   4. Cliquez sur "Tester la Mise à Jour de Statut"', 'info');
        };
    </script>
</body>
</html>
