<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test RÃ©solution Erreur 403 - eConsulat</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 6px; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        .info { border-color: #17a2b8; background: #d1ecf1; }
        .form-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 15px; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        .status.warning { background: #ffc107; color: black; }
        .debug-info { background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Test RÃ©solution Erreur 403 - eConsulat</h1>
        
        <div class="section info">
            <h3>ğŸ¯ Objectif du test</h3>
            <p>RÃ©soudre l'erreur 403 (Forbidden) lors de la crÃ©ation de demande et Ã©viter le crash JSON.parse.</p>
            <p><strong>ProblÃ¨me actuel :</strong> POST /api/demandes â†’ HTTP 403 Forbidden + crash JSON.parse</p>
        </div>

        <!-- Section Connexion -->
        <div class="section">
            <h3>ğŸ”‘ Ã‰tape 1: Connexion et obtention du token</h3>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="votre@email.com" value="test@test.com">
            </div>
            <div class="form-group">
                <label for="password">Mot de passe:</label>
                <input type="password" id="password" placeholder="Mot de passe" value="password123">
            </div>
            <button onclick="login()">ğŸ” Se connecter</button>
            <div id="loginResult" class="result"></div>
        </div>

        <!-- Section Diagnostic Token -->
        <div class="section">
            <h3>ğŸ” Ã‰tape 2: Diagnostic du token JWT</h3>
            <button onclick="diagnoseToken()">ğŸ” Diagnostiquer le token</button>
            <button onclick="validateToken()">âœ… Valider le token</button>
            <div id="tokenDiagnostic" class="result"></div>
        </div>

        <!-- Section Test Demande -->
        <div class="section">
            <h3>ğŸ“ Ã‰tape 3: Test crÃ©ation demande (avec gestion d'erreur robuste)</h3>
            <button onclick="testCreateDemandeRobust()">ğŸ§ª Tester crÃ©ation robuste</button>
            <button onclick="testCreateDemandeWithHeaders()">ğŸ“‹ Tester avec headers dÃ©taillÃ©s</button>
            <div id="demandeTestResult" class="result"></div>
        </div>

        <!-- Section Analyse Erreur -->
        <div class="section">
            <h3>ğŸš¨ Ã‰tape 4: Analyse dÃ©taillÃ©e de l'erreur 403</h3>
            <button onclick="analyze403Error()">ğŸ”¬ Analyser l'erreur 403</button>
            <button onclick="testDifferentEndpoints()">ğŸŒ Tester diffÃ©rents endpoints</button>
            <div id="errorAnalysis" class="result"></div>
        </div>

        <!-- Section Logs -->
        <div class="section">
            <h3>ğŸ“Š Logs de diagnostic</h3>
            <button onclick="clearLogs()">ğŸ—‘ï¸ Effacer les logs</button>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUser = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logsDiv.innerHTML += `[${timestamp}] <span class="status ${statusClass}">${type.toUpperCase()}</span> ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showResult('loginResult', 'error', 'âŒ Veuillez remplir tous les champs');
                return;
            }

            try {
                log('ğŸ” Tentative de connexion...', 'info');
                
                const response = await fetch('http://127.0.0.1:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                log(`ğŸ“¡ RÃ©ponse du serveur: ${response.status} ${response.statusText}`, 'info');

                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    currentUser = data;
                    
                    log('âœ… Connexion rÃ©ussie!', 'success');
                    log(`ğŸ‘¤ Utilisateur: ${data.email}`, 'info');
                    log(`ğŸ”‘ Token reÃ§u: ${data.token ? 'Oui' : 'Non'}`, 'info');
                    log(`ğŸ‘‘ RÃ´le: ${data.role}`, 'info');
                    
                    showResult('loginResult', 'success', 
                        `âœ… Connexion rÃ©ussie!\n` +
                        `ğŸ‘¤ Email: ${data.email}\n` +
                        `ğŸ‘‘ RÃ´le: ${data.role}\n` +
                        `ğŸ”‘ Token: ${data.token ? 'ReÃ§u' : 'Manquant'}`);
                } else {
                    const errorData = await response.text();
                    log(`âŒ Erreur de connexion: ${response.status} - ${errorData}`, 'error');
                    showResult('loginResult', 'error', `âŒ Erreur de connexion: ${response.status} - ${errorData}`);
                }
            } catch (error) {
                log(`âŒ Erreur de connexion: ${error.message}`, 'error');
                showResult('loginResult', 'error', `âŒ Erreur de connexion: ${error.message}`);
            }
        }

        function diagnoseToken() {
            if (!currentToken) {
                showResult('tokenDiagnostic', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                const tokenParts = currentToken.split('.');
                if (tokenParts.length !== 3) {
                    showResult('tokenDiagnostic', 'error', 'âŒ Format de token invalide');
                    return;
                }

                const header = JSON.parse(atob(tokenParts[0]));
                const payload = JSON.parse(atob(tokenParts[1]));
                const expiration = new Date(payload.exp * 1000);
                const now = new Date();

                let status = 'success';
                let message = `ğŸ” Diagnostic du token JWT:\n\n`;
                message += `ğŸ“‹ Header: ${JSON.stringify(header, null, 2)}\n\n`;
                message += `ğŸ“‹ Payload: ${JSON.stringify(payload, null, 2)}\n\n`;
                message += `â° Expiration: ${expiration.toLocaleString()}\n`;
                message += `ğŸ• Maintenant: ${now.toLocaleString()}\n`;
                message += `ğŸ‘¤ Sujet: ${payload.sub}\n`;

                if (expiration < now) {
                    status = 'error';
                    message += `\nâŒ TOKEN EXPIRÃ‰!`;
                } else if (expiration - now < 5 * 60 * 1000) { // 5 minutes
                    status = 'warning';
                    message += `\nâš ï¸ Token expire bientÃ´t!`;
                }

                showResult('tokenDiagnostic', status, message);
                log(`ğŸ” Token diagnostiquÃ©: ${payload.sub}`, status);
            } catch (error) {
                showResult('tokenDiagnostic', 'error', `âŒ Erreur lors du diagnostic: ${error.message}`);
                log(`âŒ Erreur diagnostic: ${error.message}`, 'error');
            }
        }

        async function validateToken() {
            if (!currentToken) {
                showResult('tokenDiagnostic', 'error', 'âŒ Aucun token Ã  valider. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ” Validation du token...', 'info');
                
                const response = await fetch('http://127.0.0.1:8080/api/demandes/my', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                log(`ğŸ“¡ RÃ©ponse validation: ${response.status} ${response.statusText}`, 'info');

                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Token valide!', 'success');
                    log(`ğŸ“Š Nombre de demandes: ${data.length}`, 'info');
                    
                    showResult('tokenDiagnostic', 'success', 
                        `âœ… Token valide!\n` +
                        `ğŸ“Š Nombre de demandes: ${data.length}\n` +
                        `ğŸ”“ AccÃ¨s autorisÃ© Ã  l'API`);
                } else if (response.status === 403) {
                    log('âŒ Token invalide ou expirÃ© (403 Forbidden)', 'error');
                    showResult('tokenDiagnostic', 'error', 
                        `âŒ Token invalide ou expirÃ©\n` +
                        `ğŸš« AccÃ¨s refusÃ© (403 Forbidden)\n` +
                        `ğŸ’¡ VÃ©rifiez la validitÃ© du token`);
                } else {
                    const errorData = await response.text();
                    log(`âŒ Erreur de validation: ${response.status} - ${errorData}`, 'error');
                    showResult('tokenDiagnostic', 'error', `âŒ Erreur de validation: ${response.status} - ${errorData}`);
                }
            } catch (error) {
                log(`âŒ Erreur de validation: ${error.message}`, 'error');
                showResult('tokenDiagnostic', 'error', `âŒ Erreur de validation: ${error.message}`);
            }
        }

        async function testCreateDemandeRobust() {
            if (!currentToken) {
                showResult('demandeTestResult', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ§ª Test de crÃ©ation de demande (gestion robuste)...', 'info');
                
                const testDemande = {
                    civiliteId: 1,
                    firstName: "Jean",
                    lastName: "Dupont",
                    birthDate: "1990-01-01",
                    birthPlace: "Paris",
                    birthCountryId: 1,
                    streetName: "Rue de la Paix",
                    streetNumber: "123",
                    boxNumber: "",
                    postalCode: "75001",
                    city: "Paris",
                    countryId: 1,
                    fatherFirstName: "Pierre",
                    fatherLastName: "Dupont",
                    fatherBirthDate: "1950-01-01",
                    fatherBirthPlace: "Lyon",
                    fatherBirthCountryId: 1,
                    motherFirstName: "Marie",
                    motherLastName: "Martin",
                    motherBirthDate: "1955-01-01",
                    motherBirthPlace: "Marseille",
                    motherBirthCountryId: 1,
                    documentTypeId: 1,
                    documentFiles: []
                };

                log(`ğŸ“¤ DonnÃ©es de test: ${JSON.stringify(testDemande, null, 2)}`, 'info');

                const response = await fetch('http://127.0.0.1:8080/api/demandes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(testDemande)
                });

                log(`ğŸ“¡ RÃ©ponse crÃ©ation: ${response.status} ${response.statusText}`, 'info');

                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Demande crÃ©Ã©e avec succÃ¨s!', 'success');
                    log(`ğŸ†” ID de la demande: ${data.id}`, 'info');
                    
                    showResult('demandeTestResult', 'success', 
                        `âœ… Demande crÃ©Ã©e avec succÃ¨s!\n` +
                        `ğŸ†” ID: ${data.id}\n` +
                        `ğŸ“… Date: ${data.createdAt}\n` +
                        `ğŸ“‹ Statut: ${data.status}`);
                } else if (response.status === 403) {
                    log('âŒ AccÃ¨s refusÃ© (403 Forbidden)', 'error');
                    
                    // Gestion robuste de l'erreur 403
                    let errorMessage = "AccÃ¨s refusÃ© (403 Forbidden)";
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (parseError) {
                        log(`âš ï¸ RÃ©ponse 403 vide - impossible de parser: ${parseError.message}`, 'warning');
                        errorMessage = "AccÃ¨s refusÃ© - VÃ©rifiez vos autorisations";
                    }
                    
                    showResult('demandeTestResult', 'error', 
                        `âŒ ${errorMessage}\n` +
                        `ğŸš« VÃ©rifiez les autorisations de l'utilisateur\n` +
                        `ğŸ”‘ VÃ©rifiez la validitÃ© du token\n` +
                        `ğŸ‘¤ RÃ´le utilisateur: ${currentUser?.role || 'Inconnu'}`);
                } else {
                    // Gestion robuste des autres erreurs
                    let errorMessage = `Erreur ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (parseError) {
                        log(`âš ï¸ Impossible de parser la rÃ©ponse d'erreur: ${parseError.message}`, 'warning');
                    }
                    
                    log(`âŒ Erreur de crÃ©ation: ${errorMessage}`, 'error');
                    showResult('demandeTestResult', 'error', `âŒ Erreur de crÃ©ation: ${errorMessage}`);
                }
            } catch (error) {
                log(`âŒ Erreur de test: ${error.message}`, 'error');
                showResult('demandeTestResult', 'error', `âŒ Erreur de test: ${error.message}`);
            }
        }

        async function testCreateDemandeWithHeaders() {
            if (!currentToken) {
                showResult('demandeTestResult', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ“‹ Test avec headers dÃ©taillÃ©s...', 'info');
                
                const testDemande = {
                    civiliteId: 1,
                    firstName: "Marie",
                    lastName: "Martin",
                    birthDate: "1985-05-15",
                    birthPlace: "Lyon",
                    birthCountryId: 1,
                    streetName: "Avenue des Champs",
                    streetNumber: "456",
                    boxNumber: "",
                    postalCode: "69000",
                    city: "Lyon",
                    countryId: 1,
                    fatherFirstName: "Jean",
                    fatherLastName: "Martin",
                    fatherBirthDate: "1940-01-01",
                    fatherBirthPlace: "Paris",
                    fatherBirthCountryId: 1,
                    motherFirstName: "Sophie",
                    motherLastName: "Bernard",
                    motherBirthDate: "1945-01-01",
                    motherBirthPlace: "Marseille",
                    motherBirthCountryId: 1,
                    documentTypeId: 1,
                    documentFiles: []
                };

                // Headers dÃ©taillÃ©s pour le diagnostic
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`,
                    'Accept': 'application/json',
                    'User-Agent': 'eConsulat-Diagnostic-Tool',
                    'X-Requested-With': 'XMLHttpRequest'
                };

                log(`ğŸ“‹ Headers utilisÃ©s: ${JSON.stringify(headers, null, 2)}`, 'info');

                const response = await fetch('http://127.0.0.1:8080/api/demandes', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(testDemande)
                });

                log(`ğŸ“¡ RÃ©ponse avec headers dÃ©taillÃ©s: ${response.status} ${response.statusText}`, 'info');
                log(`ğŸ“‹ Headers de rÃ©ponse: ${JSON.stringify([...response.headers.entries()], null, 2)}`, 'info');

                if (response.ok) {
                    const data = await response.json();
                    log('âœ… Demande crÃ©Ã©e avec succÃ¨s (headers dÃ©taillÃ©s)!', 'success');
                    showResult('demandeTestResult', 'success', 
                        `âœ… Demande crÃ©Ã©e avec succÃ¨s (headers dÃ©taillÃ©s)!\n` +
                        `ğŸ†” ID: ${data.id}`);
                } else if (response.status === 403) {
                    log('âŒ AccÃ¨s refusÃ© mÃªme avec headers dÃ©taillÃ©s', 'error');
                    showResult('demandeTestResult', 'error', 
                        `âŒ AccÃ¨s refusÃ© mÃªme avec headers dÃ©taillÃ©s\n` +
                        `ğŸš« Le problÃ¨me n'est pas liÃ© aux headers\n` +
                        `ğŸ’¡ VÃ©rifiez l'authentification et les autorisations`);
                } else {
                    let errorMessage = `Erreur ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (parseError) {
                        log(`âš ï¸ Impossible de parser la rÃ©ponse d'erreur: ${parseError.message}`, 'warning');
                    }
                    
                    showResult('demandeTestResult', 'error', `âŒ Erreur: ${errorMessage}`);
                }
            } catch (error) {
                log(`âŒ Erreur avec headers dÃ©taillÃ©s: ${error.message}`, 'error');
                showResult('demandeTestResult', 'error', `âŒ Erreur: ${error.message}`);
            }
        }

        async function analyze403Error() {
            if (!currentToken) {
                showResult('errorAnalysis', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸ”¬ Analyse dÃ©taillÃ©e de l\'erreur 403...', 'info');
                
                // Test 1: Endpoint de base
                log('ğŸ”¬ Test 1: Endpoint de base /api/demandes', 'info');
                const response1 = await fetch('http://127.0.0.1:8080/api/demandes', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                log(`ğŸ“¡ Test 1 - GET /api/demandes: ${response1.status} ${response1.statusText}`, 'info');

                // Test 2: Endpoint spÃ©cifique
                log('ğŸ”¬ Test 2: Endpoint spÃ©cifique /api/demandes/my', 'info');
                const response2 = await fetch('http://127.0.0.1:8080/api/demandes/my', {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                log(`ğŸ“¡ Test 2 - GET /api/demandes/my: ${response2.status} ${response2.statusText}`, 'info');

                // Test 3: Endpoint public
                log('ğŸ”¬ Test 3: Endpoint public /api/demandes/civilites', 'info');
                const response3 = await fetch('http://127.0.0.1:8080/api/demandes/civilites');
                log(`ğŸ“¡ Test 3 - GET /api/demandes/civilites: ${response3.status} ${response3.statusText}`, 'info');

                // Analyse des rÃ©sultats
                let analysis = `ğŸ”¬ Analyse de l'erreur 403:\n\n`;
                analysis += `ğŸ“Š RÃ©sultats des tests:\n`;
                analysis += `â€¢ GET /api/demandes: ${response1.status} ${response1.statusText}\n`;
                analysis += `â€¢ GET /api/demandes/my: ${response2.status} ${response2.statusText}\n`;
                analysis += `â€¢ GET /api/demandes/civilites: ${response3.status} ${response3.statusText}\n\n`;

                if (response1.status === 403 && response2.status === 403) {
                    analysis += `ğŸš¨ DIAGNOSTIC: ProblÃ¨me d'authentification global\n`;
                    analysis += `â€¢ L'utilisateur n'a pas accÃ¨s aux endpoints de demandes\n`;
                    analysis += `â€¢ VÃ©rifiez le rÃ´le de l'utilisateur: ${currentUser?.role || 'Inconnu'}\n`;
                    analysis += `â€¢ VÃ©rifiez que le token est valide et non expirÃ©\n`;
                } else if (response1.status === 403 && response2.status === 200) {
                    analysis += `âš ï¸ DIAGNOSTIC: ProblÃ¨me d'autorisation spÃ©cifique\n`;
                    analysis += `â€¢ L'utilisateur peut voir ses demandes mais pas crÃ©er\n`;
                    analysis += `â€¢ VÃ©rifiez les permissions de crÃ©ation\n`;
                } else if (response3.status === 200) {
                    analysis += `âœ… DIAGNOSTIC: Endpoints publics accessibles\n`;
                    analysis += `â€¢ La configuration CORS et la connectivitÃ© sont OK\n`;
                }

                showResult('errorAnalysis', 'info', analysis);
                log('ğŸ”¬ Analyse terminÃ©e', 'info');

            } catch (error) {
                log(`âŒ Erreur lors de l'analyse: ${error.message}`, 'error');
                showResult('errorAnalysis', 'error', `âŒ Erreur lors de l'analyse: ${error.message}`);
            }
        }

        async function testDifferentEndpoints() {
            if (!currentToken) {
                showResult('errorAnalysis', 'error', 'âŒ Aucun token disponible. Connectez-vous d\'abord.');
                return;
            }

            try {
                log('ğŸŒ Test de diffÃ©rents endpoints...', 'info');
                
                const endpoints = [
                    { name: 'Auth Profile', url: '/api/auth/profile', method: 'GET' },
                    { name: 'Users Profile', url: '/api/users', method: 'GET' },
                    { name: 'Admin Stats', url: '/api/admin/stats', method: 'GET' },
                    { name: 'Document Types', url: '/api/demandes/document-types', method: 'GET' }
                ];

                let results = `ğŸŒ Test de diffÃ©rents endpoints:\n\n`;

                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(`http://127.0.0.1:8080${endpoint.url}`, {
                            method: endpoint.method,
                            headers: { 'Authorization': `Bearer ${currentToken}` }
                        });

                        const status = response.status;
                        const statusText = response.statusText;
                        
                        results += `${endpoint.name} (${endpoint.method} ${endpoint.url}): ${status} ${statusText}\n`;
                        
                        if (response.ok) {
                            log(`âœ… ${endpoint.name}: ${status}`, 'success');
                        } else if (response.status === 403) {
                            log(`âŒ ${endpoint.name}: ${status} (Forbidden)`, 'error');
                        } else {
                            log(`âš ï¸ ${endpoint.name}: ${status}`, 'warning');
                        }
                    } catch (error) {
                        results += `${endpoint.name}: Erreur de connexion\n`;
                        log(`âŒ ${endpoint.name}: Erreur de connexion`, 'error');
                    }
                }

                showResult('errorAnalysis', 'info', results);
                log('ğŸŒ Test des endpoints terminÃ©', 'info');

            } catch (error) {
                log(`âŒ Erreur lors du test des endpoints: ${error.message}`, 'error');
                showResult('errorAnalysis', 'error', `âŒ Erreur lors du test des endpoints: ${error.message}`);
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('ğŸ—‘ï¸ Logs effacÃ©s', 'warning');
        }

        // Initialisation
        log('ğŸš€ Test de rÃ©solution d\'erreur 403 dÃ©marrÃ©', 'info');
        log('ğŸ’¡ Connectez-vous d\'abord, puis testez la crÃ©ation de demande', 'info');
    </script>
</body>
</html>
