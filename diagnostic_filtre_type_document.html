<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagnostic - Filtre Type de Document</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #0066cc; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
        .log-debug { color: #6c757d; }
        .filter-demo {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .filter-select {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 5px;
            min-width: 200px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .debug-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 11px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Diagnostic - Filtre Type de Document</h1>
    
    <div class="container">
        <h2>üìã Test de l'API des Types de Documents</h2>
        <p>V√©rification de la r√©cup√©ration des types de documents depuis la base de donn√©es.</p>
        
        <button class="btn" onclick="testDocumentTypesAPI()">Test API Types de Documents</button>
        <button class="btn" onclick="testAdminDocumentTypesAPI()">Test API Admin Types</button>
        <button class="btn btn-warning" onclick="testDemandesAPI()">Test API Demandes</button>
        
        <div id="apiResult" class="result-box"></div>
    </div>

    <div class="container">
        <h2>üîç Test du Filtrage</h2>
        <p>Simulation du comportement du filtre avec les donn√©es r√©elles.</p>
        
        <div class="filter-demo">
            <label><strong>Type de document :</strong></label>
            <select id="documentTypeFilter" class="filter-select" onchange="applyFilter()">
                <option value="">Tous les types</option>
                <option value="">Chargement des types...</option>
            </select>
            
            <br><br>
            <label><strong>Statut :</strong></label>
            <select id="statusFilter" class="filter-select" onchange="applyFilter()">
                <option value="">Tous les statuts</option>
                <option value="PENDING">En attente</option>
                <option value="APPROVED">Approuv√©</option>
                <option value="REJECTED">Rejet√©</option>
            </select>
        </div>
        
        <div id="filterResult" class="result-box">
            <div class="log-entry log-info">S√©lectionnez des filtres pour voir les r√©sultats...</div>
        </div>
    </div>

    <div class="container">
        <h2>üìä Analyse des Donn√©es</h2>
        <p>Examen d√©taill√© de la structure des donn√©es et du processus de filtrage.</p>
        
        <div id="dataAnalysis" class="result-box"></div>
        
        <button class="btn btn-success" onclick="analyzeData()">Analyser les Donn√©es</button>
        <button class="btn btn-warning" onclick="debugFiltering()">Debug du Filtrage</button>
        <button class="btn btn-danger" onclick="clearResults()">Effacer R√©sultats</button>
    </div>

    <div class="container">
        <h2>üêõ Debug du Code</h2>
        <p>V√©rification de la logique de filtrage et des correspondances.</p>
        
        <div class="debug-section">
            <h3>üîç Probl√®mes Potentiels Identifi√©s :</h3>
            <ul>
                <li><strong>Mismatch de valeurs :</strong> Les valeurs du filtre ne correspondent pas aux donn√©es des demandes</li>
                <li><strong>Structure des donn√©es :</strong> Diff√©rence entre documentType et documentTypeDisplay</li>
                <li><strong>Logique de filtrage :</strong> La correspondance peut √©chouer √† cause de la casse ou des formats</li>
                <li><strong>Chargement asynchrone :</strong> Les types peuvent ne pas √™tre charg√©s au moment du filtrage</li>
            </ul>
        </div>
        
        <div id="debugResult" class="result-box"></div>
    </div>

    <script>
        // Donn√©es de test et d'analyse
        let testDemandes = [];
        let documentTypes = [];
        let debugInfo = {};

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            element.appendChild(entry);
            element.scrollTop = element.scrollHeight;
        }

        async function testDocumentTypesAPI() {
            const resultBox = document.getElementById('apiResult');
            resultBox.innerHTML = '';
            
            log('apiResult', 'üîÑ Test de l\'API /api/demandes/document-types...', 'info');
            
            try {
                const response = await fetch('http://localhost:8080/api/demandes/document-types');
                
                if (response.ok) {
                    const data = await response.json();
                    log('apiResult', `‚úÖ ${data.length} types de documents r√©cup√©r√©s`, 'success');
                    
                    data.forEach((type, index) => {
                        log('apiResult', `   ${index + 1}. value: "${type.value}", label: "${type.label}"`, 'info');
                    });
                    
                    // Mettre √† jour le select de d√©monstration
                    updateFilterSelect(data);
                    documentTypes = data;
                    
                    // Analyser la structure
                    debugInfo.documentTypes = data;
                    
                } else {
                    log('apiResult', `‚ùå Erreur: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (err) {
                log('apiResult', `‚ùå Erreur de connexion: ${err.message}`, 'error');
            }
        }

        async function testAdminDocumentTypesAPI() {
            const resultBox = document.getElementById('apiResult');
            
            log('apiResult', 'üîÑ Test de l\'API /api/admin/document-types...', 'info');
            
            try {
                const response = await fetch('http://localhost:8080/api/admin/document-types');
                
                if (response.ok) {
                    const data = await response.json();
                    log('apiResult', `‚úÖ ${data.length} types de documents admin r√©cup√©r√©s`, 'success');
                    
                    data.forEach((type, index) => {
                        log('apiResult', `   ${index + 1}. id: ${type.id}, libelle: "${type.libelle}"`, 'info');
                    });
                    
                } else {
                    log('apiResult', `‚ùå Erreur: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (err) {
                log('apiResult', `‚ùå Erreur de connexion: ${err.message}`, 'error');
            }
        }

        async function testDemandesAPI() {
            const resultBox = document.getElementById('apiResult');
            
            log('apiResult', 'üîÑ Test de l\'API /api/demandes/my...', 'info');
            
            try {
                // Simuler un token pour le test
                const mockToken = 'mock-token-for-testing';
                const response = await fetch('http://localhost:8080/api/demandes/my', {
                    headers: {
                        'Authorization': `Bearer ${mockToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('apiResult', `‚úÖ ${data.length} demandes r√©cup√©r√©es`, 'success');
                    
                    // Analyser la structure des demandes
                    if (data.length > 0) {
                        const firstDemande = data[0];
                        log('apiResult', `üìä Structure de la premi√®re demande:`, 'info');
                        log('apiResult', `   documentType: "${firstDemande.documentType}"`, 'debug');
                        log('apiResult', `   documentTypeDisplay: "${firstDemande.documentTypeDisplay}"`, 'debug');
                        log('apiResult', `   status: "${firstDemande.status}"`, 'debug');
                    }
                    
                    testDemandes = data;
                    debugInfo.demandes = data;
                    
                } else {
                    log('apiResult', `‚ùå Erreur: ${response.status} ${response.statusText}`, 'error');
                    log('apiResult', 'üí° Note: Cette erreur est normale sans authentification', 'warning');
                }
            } catch (err) {
                log('apiResult', `‚ùå Erreur de connexion: ${err.message}`, 'error');
            }
        }

        function updateFilterSelect(types) {
            const select = document.getElementById('documentTypeFilter');
            select.innerHTML = '<option value="">Tous les types</option>';
            
            if (types && types.length > 0) {
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.value || type.label || type.libelle;
                    option.textContent = type.label || type.libelle || type.value;
                    select.appendChild(option);
                });
            } else {
                // Fallback
                const fallbackTypes = [
                    'Passeport', 'Acte de naissance', 'Certificat de mariage', 
                    'Carte d\'identit√©', 'Autre'
                ];
                fallbackTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
            }
        }

        function applyFilter() {
            if (testDemandes.length === 0) {
                log('filterResult', '‚ö†Ô∏è Chargez d\'abord les donn√©es de test', 'warning');
                return;
            }
            
            const documentTypeFilter = document.getElementById('documentTypeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const resultBox = document.getElementById('filterResult');
            resultBox.innerHTML = '';
            
            log('filterResult', `üîç Application des filtres:`, 'info');
            log('filterResult', `   Type de document: "${documentTypeFilter || 'Tous'}"`, 'info');
            log('filterResult', `   Statut: "${statusFilter || 'Tous'}"`, 'info');
            
            // Debug du filtrage
            log('filterResult', `üìä Donn√©es avant filtrage: ${testDemandes.length} demandes`, 'debug');
            
            // Filtrage avec debug
            const filteredDemandes = testDemandes.filter(demande => {
                const matchesDocumentType = !documentTypeFilter || 
                    demande.documentTypeDisplay === documentTypeFilter ||
                    demande.documentType === documentTypeFilter;
                
                const matchesStatus = !statusFilter || demande.status === statusFilter;
                
                // Debug de chaque demande
                if (documentTypeFilter) {
                    log('filterResult', `üîç Demande #${demande.id}:`, 'debug');
                    log('filterResult', `   documentType: "${demande.documentType}"`, 'debug');
                    log('filterResult', `   documentTypeDisplay: "${demande.documentTypeDisplay}"`, 'debug');
                    log('filterResult', `   filterValue: "${documentTypeFilter}"`, 'debug');
                    log('filterResult', `   match: ${matchesDocumentType}`, matchesDocumentType ? 'success' : 'error');
                }
                
                return matchesDocumentType && matchesStatus;
            });
            
            log('filterResult', `üìä R√©sultats: ${filteredDemandes.length}/${testDemandes.length} demandes`, 'success');
            
            filteredDemandes.forEach(demande => {
                const statusClass = `status-${demande.status.toLowerCase()}`;
                log('filterResult', `   ‚úÖ #${demande.id} ${demande.firstName} ${demande.lastName} - ${demande.documentTypeDisplay} <span class="status-badge ${statusClass}">${demande.statusDisplay}</span>`, 'success');
            });
        }

        function analyzeData() {
            const resultBox = document.getElementById('dataAnalysis');
            resultBox.innerHTML = '';
            
            log('dataAnalysis', 'üîç Analyse des donn√©es...', 'info');
            
            if (testDemandes.length === 0) {
                log('dataAnalysis', '‚ö†Ô∏è Aucune demande √† analyser. Chargez d\'abord les donn√©es.', 'warning');
                return;
            }
            
            // Analyser la structure des demandes
            log('dataAnalysis', `üìä Analyse de ${testDemandes.length} demandes:`, 'info');
            
            const uniqueDocumentTypes = new Set();
            const uniqueDocumentTypeDisplays = new Set();
            const uniqueStatuses = new Set();
            
            testDemandes.forEach((demande, index) => {
                uniqueDocumentTypes.add(demande.documentType);
                uniqueDocumentTypeDisplays.add(demande.documentTypeDisplay);
                uniqueStatuses.add(demande.status);
                
                if (index < 3) { // Afficher les 3 premi√®res demandes
                    log('dataAnalysis', `   Demande #${demande.id}:`, 'debug');
                    log('dataAnalysis', `     documentType: "${demande.documentType}"`, 'debug');
                    log('dataAnalysis', `     documentTypeDisplay: "${demande.documentTypeDisplay}"`, 'debug');
                    log('dataAnalysis', `     status: "${demande.status}"`, 'debug');
                }
            });
            
            log('dataAnalysis', `üìã Types de documents uniques:`, 'info');
            Array.from(uniqueDocumentTypes).forEach(type => {
                log('dataAnalysis', `   - "${type}"`, 'info');
            });
            
            log('dataAnalysis', `üìã Types d'affichage uniques:`, 'info');
            Array.from(uniqueDocumentTypeDisplays).forEach(type => {
                log('dataAnalysis', `   - "${type}"`, 'info');
            });
            
            log('dataAnalysis', `üìã Statuts uniques:`, 'info');
            Array.from(uniqueStatuses).forEach(status => {
                log('dataAnalysis', `   - "${status}"`, 'info');
            });
            
            // Analyser la correspondance avec les types de documents
            if (documentTypes.length > 0) {
                log('dataAnalysis', `üîó Correspondance avec les types de documents:`, 'info');
                
                documentTypes.forEach(type => {
                    const matchingDemandes = testDemandes.filter(demande => 
                        demande.documentTypeDisplay === type.label ||
                        demande.documentType === type.value
                    );
                    
                    log('dataAnalysis', `   Type "${type.label}" (${type.value}): ${matchingDemandes.length} demandes`, 'info');
                });
            }
        }

        function debugFiltering() {
            const resultBox = document.getElementById('debugResult');
            resultBox.innerHTML = '';
            
            log('debugResult', 'üêõ Debug du processus de filtrage...', 'info');
            
            if (testDemandes.length === 0 || documentTypes.length === 0) {
                log('debugResult', '‚ö†Ô∏è Donn√©es insuffisantes pour le debug', 'warning');
                return;
            }
            
            // Simuler le filtrage √©tape par √©tape
            log('debugResult', 'üîç Simulation du filtrage pour chaque type:', 'info');
            
            documentTypes.forEach(type => {
                log('debugResult', `\nüìã Test du type "${type.label}" (${type.value}):`, 'info');
                
                const matchingDemandes = testDemandes.filter(demande => {
                    const match1 = demande.documentTypeDisplay === type.label;
                    const match2 = demande.documentType === type.value;
                    const match3 = demande.documentTypeDisplay === type.value;
                    const match4 = demande.documentType === type.label;
                    
                    log('debugResult', `   Demande #${demande.id}:`, 'debug');
                    log('debugResult', `     documentTypeDisplay === type.label: "${demande.documentTypeDisplay}" === "${type.label}" = ${match1}`, 'debug');
                    log('debugResult', `     documentType === type.value: "${demande.documentType}" === "${type.value}" = ${match2}`, 'debug');
                    log('debugResult', `     documentTypeDisplay === type.value: "${demande.documentTypeDisplay}" === "${type.value}" = ${match3}`, 'debug');
                    log('debugResult', `     documentType === type.label: "${demande.documentType}" === "${type.label}" = ${match4}`, 'debug');
                    
                    return match1 || match2 || match3 || match4;
                });
                
                log('debugResult', `   ‚úÖ ${matchingDemandes.length} demandes correspondent`, 'success');
            });
            
            // Analyser les probl√®mes potentiels
            log('debugResult', '\nüö® Probl√®mes potentiels identifi√©s:', 'warning');
            
            const problems = [];
            
            // V√©rifier la coh√©rence des donn√©es
            testDemandes.forEach(demande => {
                if (demande.documentType && demande.documentTypeDisplay) {
                    if (demande.documentType !== demande.documentTypeDisplay) {
                        problems.push(`Demande #${demande.id}: documentType (${demande.documentType}) ‚â† documentTypeDisplay (${demande.documentTypeDisplay})`);
                    }
                }
            });
            
            if (problems.length > 0) {
                problems.forEach(problem => {
                    log('debugResult', `   ‚ö†Ô∏è ${problem}`, 'warning');
                });
            } else {
                log('debugResult', '   ‚úÖ Aucun probl√®me de coh√©rence d√©tect√©', 'success');
            }
        }

        function clearResults() {
            document.getElementById('apiResult').innerHTML = '';
            document.getElementById('filterResult').innerHTML = '';
            document.getElementById('dataAnalysis').innerHTML = '';
            document.getElementById('debugResult').innerHTML = '';
            testDemandes = [];
            documentTypes = [];
            debugInfo = {};
        }

        // Initialisation
        log('apiResult', 'üöÄ Diagnostic initialis√©. Commencez par tester l\'API des types de documents.', 'info');
        log('apiResult', 'üí° Ordre recommand√©: 1) Types de documents, 2) Demandes, 3) Analyse, 4) Debug', 'info');
    </script>
</body>
</html>
